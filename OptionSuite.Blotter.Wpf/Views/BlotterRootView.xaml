<UserControl x:Class="OptionSuite.Blotter.Wpf.Views.BlotterRootView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:OptionSuite.Blotter.Wpf.Converters">


    <UserControl.Resources>


        <!-- D2.2D: Converters -->
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>
        <converters:NullToCollapsedConverter x:Key="NullToCollapsed"/>
        <converters:DetailsToLinesConverter x:Key="DetailsToLines"/>
        <converters:EventTypeToIconConverter x:Key="EventTypeToIcon"/>
        <converters:EventTypeToColorConverter x:Key="EventTypeToColor"/>
        <converters:ProperCaseConverter x:Key="ProperCase"/>

        <!-- =========================================================
             SOFT FOG (token-baserad)
             Bygger “dimmad” top-to-bottom känsla över hela contentytan.
             Endast tokens: Panel/Panel2/BorderSoft/Glow.Accent/Transparent.
             ========================================================= -->
        <LinearGradientBrush x:Key="Blotter.Brush.ContentFog" StartPoint="0,0" EndPoint="0,1">
            <!-- Lite ljusare uppe -->
            <GradientStop Color="{StaticResource Color.BorderSoft}" Offset="0.0"/>
            <!-- Dimmad blå ton -->
            <GradientStop Color="{StaticResource Color.Glow.Accent}" Offset="0.35"/>
            <!-- Ner mot panel -->
            <GradientStop Color="{StaticResource Color.Transparent}" Offset="1.0"/>
        </LinearGradientBrush>

        <!-- =========================================================
             Status-/filterstrip (kvar – ingen funktionalitet ändras)
             ========================================================= -->
        <Style x:Key="BlotterStripButtonBaseStyle" TargetType="Button">
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Margin" Value="0,0,8,0"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{StaticResource Brush.BorderSoft}"/>
            <Setter Property="Background" Value="{StaticResource Brush.Panel}"/>
            <Setter Property="Foreground" Value="{StaticResource Brush.TextMuted}"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{StaticResource Radius.Button}">
                            <ContentPresenter Margin="{TemplateBinding Padding}"
                                              VerticalAlignment="Center"
                                              HorizontalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="BlotterStripButtonActiveStyle"
               TargetType="Button"
               BasedOn="{StaticResource BlotterStripButtonBaseStyle}">
            <Setter Property="Foreground" Value="{StaticResource Brush.Text}"/>
            <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}"/>
            <Setter Property="Background" Value="{StaticResource Brush.Panel2}"/>
        </Style>

        <Style x:Key="BlotterStripCountBadgeStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource Brush.Panel2}"/>
            <Setter Property="BorderBrush" Value="{StaticResource Brush.BorderSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="{StaticResource Radius.Button}"/>
            <Setter Property="Padding" Value="8,1"/>
            <Setter Property="Margin" Value="8,0,0,0"/>
        </Style>

        <Style x:Key="BlotterStripCountTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Foreground" Value="{StaticResource Brush.TextMuted}"/>
        </Style>

        <!-- Combined Status + New badge - med Grid för alignment -->
        <DataTemplate x:Key="StatusPillTemplate">
            <Grid HorizontalAlignment="Left">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <!-- Status pill -->
                    <ColumnDefinition Width="8"/>
                    <!-- Margin -->
                    <ColumnDefinition Width="Auto"/>
                    <!-- New badge -->
                </Grid.ColumnDefinitions>

                <!-- Status pill -->
                <Border Grid.Column="0"
                BorderBrush="{StaticResource Brush.BorderSoft}"
                BorderThickness="1"
                Background="{StaticResource Blotter.Brush.GlassPill}"
                CornerRadius="{StaticResource Radius.Button}"
                Padding="10,3"
                MinWidth="80">
                    <!-- Minsta bredd så alla status får samma space -->
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <Ellipse Width="7" Height="7" Margin="0,0,8,0" VerticalAlignment="Center">
                            <Ellipse.Style>
                                <Style TargetType="Ellipse">
                                    <Setter Property="Fill" Value="{StaticResource Brush.TextMuted}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Status}" Value="New">
                                            <Setter Property="Fill" Value="#3B82F6"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Booked">
                                            <Setter Property="Fill" Value="#2DD4BF"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Pending">
                                            <Setter Property="Fill" Value="#FBBF24"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Rejected">
                                            <Setter Property="Fill" Value="#FB7185"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Partial">
                                            <Setter Property="Fill" Value="#FB923C"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Ellipse.Style>
                        </Ellipse>

                        <TextBlock Text="{Binding Status, Converter={StaticResource ProperCase}}"
           Foreground="{StaticResource Brush.Text}"
           FontSize="12"
           VerticalAlignment="Center"/>

                    </StackPanel>
                </Border>

                <!-- New badge (Grid.Column="2" så den hamnar efter marginal) -->
                <Border Grid.Column="2"
                Style="{StaticResource NewBadgeBorderStyle}"
                VerticalAlignment="Center"
                Visibility="{Binding IsNew, Converter={StaticResource BoolToVisConverter}}">
                    <TextBlock Text="New" Style="{StaticResource NewBadgeTextStyle}"/>
                </Border>

            </Grid>
        </DataTemplate>




        <!-- =========================================================
             Detail tabs (högerpanelen) – oförändrat
             ========================================================= -->
        <Style x:Key="DetailTabButtonBaseStyle" TargetType="Button">
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Margin" Value="0,0,6,0"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource Brush.TextMuted}"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{StaticResource Radius.Button}">
                            <ContentPresenter Margin="{TemplateBinding Padding}"
                                              VerticalAlignment="Center"
                                              HorizontalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DetailTabButtonActiveStyle"
               TargetType="Button"
               BasedOn="{StaticResource DetailTabButtonBaseStyle}">
            <Setter Property="Foreground" Value="{StaticResource Brush.Text}"/>
            <Setter Property="Background" Value="{StaticResource Brush.Panel2}"/>
            <Setter Property="BorderBrush" Value="{StaticResource Brush.BorderSoft}"/>
        </Style>



    </UserControl.Resources>

    <Grid Margin="{StaticResource Thickness.WindowPadding}">

        <Border Background="{StaticResource Brush.Panel}"
                BorderBrush="{StaticResource Brush.Border}"
                BorderThickness="1"
                CornerRadius="0">

            <Grid Margin="{StaticResource Thickness.WindowPadding}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Title -->
                <StackPanel Grid.Row="0">
                    <TextBlock Text="{Binding Title}"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource Brush.Text}" />

                    <TextBlock Text="{Binding Subtitle}"
                               Margin="0,6,0,0"
                               FontSize="12"
                               Foreground="{StaticResource Brush.TextMuted}" />
                </StackPanel>

                <!-- Main area -->
                <Border Grid.Row="1"
                        Margin="0,14,0,0"
                        BorderBrush="{StaticResource Brush.BorderSoft}"
                        BorderThickness="1"
                        CornerRadius="{StaticResource Radius.Button}"
                        Background="{StaticResource Brush.Panel2}">

                    <!-- Gemensam “fog” över ALLT (toolbar + filter + grid + detail) -->
                    <Grid Background="{StaticResource Blotter.Brush.ContentFog}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- =========================================================
                             TOOLBAR + FILTER STRIP
                             Låt fog ligga under; använd bara separators.
                             ========================================================= -->
                        <Grid Grid.Row="0" Background="Transparent">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="1"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="1"/>
                            </Grid.RowDefinitions>

                            <!-- Toolbar -->
                            <Grid Grid.Row="0" Background="Transparent">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Left actions -->
                                <StackPanel Orientation="Horizontal"
                                            Margin="12"
                                            VerticalAlignment="Center">

                                    <Button Command="{Binding BookTradeCommand}" 
        Margin="0,0,0,0"
        Cursor="Hand">
                                        <Button.Style>
                                            <Style TargetType="Button" BasedOn="{StaticResource Style.BlotterToolbarButton}">
                                                <Setter Property="Background" Value="#1A2DD4BF"/>
                                                <Setter Property="BorderBrush" Value="#2DD4BF"/>
                                                <Setter Property="Foreground" Value="#2DD4BF"/>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#332DD4BF"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <TextBlock Text="▶"
                   Margin="0,0,8,0"
                   FontSize="11"
                   Foreground="#2DD4BF"
                   VerticalAlignment="Center"/>
                                            <TextBlock Text="Book"
                   VerticalAlignment="Center"/>

                                            <Border Style="{StaticResource Style.BlotterShortcutPill}"
                Margin="10,0,0,0">
                                                <TextBlock Style="{StaticResource Style.BlotterShortcutPillText}"
                       Text="Ctrl+B"/>
                                            </Border>
                                        </StackPanel>
                                    </Button>


                                    <Button Style="{StaticResource Style.BlotterToolbarButton}"
                                            Content="Refresh"
                                            Command="{Binding RefreshCommand}"
                                            Margin="10,0,0,0"/>


                                    <Button Style="{StaticResource Style.BlotterToolbarButton}"
                                            Content="Export"
                                            Margin="10,0,0,0"/>

                                    <Button Style="{StaticResource Style.BlotterToolbarButton}"
                                            Content="Clear filters"
                                            Margin="10,0,0,0"/>
                                </StackPanel>

                                <!-- Right tools -->
                                <StackPanel Grid.Column="1"
                                            Orientation="Horizontal"
                                            Margin="12"
                                            VerticalAlignment="Center">

                                    <!-- Search -->
                                    <Border CornerRadius="{StaticResource Radius.Button}"
                                            BorderBrush="{StaticResource Brush.Border}"
                                            BorderThickness="1"
                                            Background="{StaticResource Brush.PanelChromeTitle}"
                                            Padding="10,7"
                                            MinWidth="300">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <TextBlock Text="Search"
                                                       Foreground="{StaticResource Brush.TextMuted}"
                                                       VerticalAlignment="Center"/>

                                            <TextBox Grid.Column="1"
                                                     Margin="10,0"
                                                     Background="Transparent"
                                                     BorderThickness="0"
                                                     Foreground="{StaticResource Brush.Text}"
                                                     FontSize="12"
                                                     VerticalContentAlignment="Center"/>

                                            <Border Grid.Column="2"
                                                    CornerRadius="7"
                                                    BorderBrush="{StaticResource Brush.BorderSoft}"
                                                    BorderThickness="1"
                                                    Background="{StaticResource Brush.PanelChromeTitle}"
                                                    Padding="6,2"
                                                    VerticalAlignment="Center">
                                                <TextBlock Text="Ctrl+F"
                                                           FontFamily="{StaticResource Font.Mono}"
                                                           FontSize="11"
                                                           Foreground="{StaticResource Brush.TextMuted}"/>
                                            </Border>
                                        </Grid>
                                    </Border>

                                    <Button Style="{StaticResource Style.BlotterToolbarButton}"
                                            Content="Columns"
                                            Margin="10,0,0,0"/>

                                    <Button Style="{StaticResource Style.BlotterToolbarButton}"
                                            Content="Settings"
                                            Margin="10,0,0,0"/>
                                </StackPanel>
                            </Grid>

                            <!-- Separator toolbar -> filter -->
                            <Border Grid.Row="1" Background="{StaticResource Brush.Border}"/>

                            <!-- Filter strip -->
                            <Border Grid.Row="2" Background="Transparent">
                                <StackPanel Orientation="Horizontal" Margin="12,10">

                                    <RadioButton GroupName="BlotterStatusFilter"
                                                 Style="{StaticResource Style.BlotterStripToggle}"
                                                 IsChecked="True"
                                                 Command="{Binding SetFilterAllCommand}"
                                                 CommandParameter="ALL">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <TextBlock Text="All" Style="{StaticResource Style.BlotterStripLabel}"/>
                                            <Border Style="{StaticResource Style.BlotterCountPill}" Margin="8,0,0,0">
                                                <TextBlock Text="{Binding TotalTrades}" Style="{StaticResource Style.BlotterCountPillText}"/>
                                            </Border>
                                        </StackPanel>
                                    </RadioButton>

                                    <RadioButton GroupName="BlotterStatusFilter"
                                                 Style="{StaticResource Style.BlotterStripToggle}"
                                                 Margin="6,0,0,0"
                                                 Command="{Binding SetFilterNewCommand}"
                                                 CommandParameter="NEW">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <TextBlock Text="New" Style="{StaticResource Style.BlotterStripLabel}"/>
                                            <Border Style="{StaticResource Style.BlotterCountPill}" Margin="8,0,0,0">
                                                <TextBlock Text="{Binding NewCount}" Style="{StaticResource Style.BlotterCountPillText}"/>
                                            </Border>
                                        </StackPanel>
                                    </RadioButton>

                                    <RadioButton GroupName="BlotterStatusFilter"
                                                 Style="{StaticResource Style.BlotterStripToggle}"
                                                 Margin="6,0,0,0"
                                                 Command="{Binding SetFilterPendingCommand}"
                                                 CommandParameter="PENDING">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <TextBlock Text="Pending" Style="{StaticResource Style.BlotterStripLabel}"/>
                                            <Border Style="{StaticResource Style.BlotterCountPill}" Margin="8,0,0,0">
                                                <TextBlock Text="{Binding PendingCount}" Style="{StaticResource Style.BlotterCountPillText}"/>
                                            </Border>
                                        </StackPanel>
                                    </RadioButton>

                                    <RadioButton GroupName="BlotterStatusFilter"
                                                 Style="{StaticResource Style.BlotterStripToggle}"
                                                 Margin="6,0,0,0"
                                                 Command="{Binding SetFilterBookedCommand}"
                                                 CommandParameter="BOOKED">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <TextBlock Text="Booked" Style="{StaticResource Style.BlotterStripLabel}"/>
                                            <Border Style="{StaticResource Style.BlotterCountPill}" Margin="8,0,0,0">
                                                <TextBlock Text="{Binding BookedCount}" Style="{StaticResource Style.BlotterCountPillText}"/>
                                            </Border>
                                        </StackPanel>
                                    </RadioButton>

                                    <RadioButton GroupName="BlotterStatusFilter"
                                                 Style="{StaticResource Style.BlotterStripToggle}"
                                                 Margin="6,0,0,0"
                                                 Command="{Binding SetFilterErrorsCommand}"
                                                 CommandParameter="ERRORS">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <TextBlock Text="Errors" Style="{StaticResource Style.BlotterStripLabel}"/>
                                            <Border Style="{StaticResource Style.BlotterCountPill}" Margin="8,0,0,0">
                                                <TextBlock Text="{Binding ErrorCount}" Style="{StaticResource Style.BlotterCountPillText}"/>
                                            </Border>
                                        </StackPanel>
                                    </RadioButton>


                                </StackPanel>
                            </Border>


                            <!-- Separator filter -> content -->
                            <Border Grid.Row="3" Background="{StaticResource Brush.Border}"/>
                        </Grid>

                        <!-- =========================================================
                             CONTENT (Grid + Detail)
                             Fog ligger under, så här håller vi ytor transparenta.
                             ========================================================= -->
                        <Grid Grid.Row="1" Background="Transparent">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="1"/>
                                <ColumnDefinition Width="360"/>
                            </Grid.ColumnDefinitions>


                            <Grid>
                                <Grid.RowDefinitions>
                                    <!-- Section header för options -->
                                    <RowDefinition Height="Auto"/>
                                    <!-- Options grid -->
                                    <RowDefinition Height="*"/>
                                    <!-- Gap mellan grids -->
                                    <RowDefinition Height="12"/>
                                    <!-- Section header för linear -->
                                    <RowDefinition Height="Auto"/>
                                    <!-- Linear grid -->
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- ==================== OPTIONS SECTION ==================== -->
                                <Border Grid.Row="0" Style="{StaticResource Style.BlotterSectionHeader.Options}">
                                    <TextBlock Text="OPTIONS (VANILLA • NDO)" 
                                               Style="{StaticResource Style.BlotterSectionHeaderText}"/>
                                </Border>

                                <!-- OPTIONS GRID - bind till SelectedOptionTrade -->
                                <DataGrid Grid.Row="1"
                                          x:Name="OptionGrid"
                                          Style="{StaticResource Style.BlotterDataGrid}"
                                          ItemsSource="{Binding OptionTradesView}"
                                          SelectedItem="{Binding SelectedOptionTrade, Mode=TwoWay}"
                                          ColumnHeaderStyle="{StaticResource Style.BlotterDataGridHeader}"
                                          CellStyle="{StaticResource Style.BlotterDataGridCell}"
                                          RowStyle="{StaticResource Style.BlotterDataGridRow.Options}"
                                          AutoGenerateColumns="False">

                                    <DataGrid.ContextMenu>
                                        <ContextMenu Style="{StaticResource Style.BlotterContextMenu}">
                                            <MenuItem Header="Book Trade" 
                  Command="{Binding BookTradeCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Duplicate Trade" 
                  Command="{Binding DuplicateTradeCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Copy To Manual Input" 
                  Command="{Binding CopyToManualInputCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Book As Live Trade" 
                  Command="{Binding BookAsLiveTradeCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <Separator Style="{StaticResource Style.BlotterMenuSeparator}"/>
                                            <MenuItem Header="Delete Row" 
                  Command="{Binding DeleteRowCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <Separator Style="{StaticResource Style.BlotterMenuSeparator}"/>
                                            <MenuItem Header="Check If Trade Is Booked" 
                  Command="{Binding CheckIfBookedCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Open Error Log" 
                  Command="{Binding OpenErrorLogCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                        </ContextMenu>
                                    </DataGrid.ContextMenu>


                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="TradeID" Binding="{Binding TradeId}" Width="120"/>
                                        <DataGridTextColumn Header="Counterpart" Binding="{Binding Counterparty}" Width="100"/>
                                        <DataGridTextColumn Header="Ccy Pair" Binding="{Binding CcyPair}" Width="80"/>
                                        <DataGridTextColumn Header="Buy/Sell" Binding="{Binding BuySell}" Width="70"/>
                                        <DataGridTextColumn Header="Call/Put" Binding="{Binding CallPut}" Width="70"/>
                                        <DataGridTextColumn Header="Strike" 
                                                            Binding="{Binding Strike, StringFormat=F4}" 
                                                            Width="65"
                                                            CellStyle="{StaticResource Style.BlotterDataGridCell.Numeric}"
                                                            HeaderStyle="{StaticResource Style.BlotterDataGridHeader.Numeric}"/>
                                        <DataGridTextColumn Header="Expiry Date" Binding="{Binding ExpiryDate, StringFormat=yyyy-MM-dd}" Width="100"/>
                                        <DataGridTextColumn Header="Notional" 
                                                            Binding="{Binding Notional, StringFormat=N0}" 
                                                            Width="90"
                                                            CellStyle="{StaticResource Style.BlotterDataGridCell.Numeric}"
                                                            HeaderStyle="{StaticResource Style.BlotterDataGridHeader.Numeric}"/>
                                        <DataGridTextColumn Header="Notional Ccy" Binding="{Binding NotionalCcy}" Width="100"/>
                                        <DataGridTextColumn Header="Premium" 
                                                            Binding="{Binding Premium, StringFormat=N2}" 
                                                            Width="90"
                                                            CellStyle="{StaticResource Style.BlotterDataGridCell.Numeric}"
                                                            HeaderStyle="{StaticResource Style.BlotterDataGridHeader.Numeric}"/>
                                        <DataGridTextColumn Header="Premium Ccy" Binding="{Binding PremiumCcy}" Width="100"/>
                                        <DataGridTextColumn Header="Portfolio MX3" Binding="{Binding PortfolioMx3}" Width="110"/>
                                        <DataGridTextColumn Header="Trader" Binding="{Binding Trader}" Width="80"/>
                                        <DataGridTemplateColumn Header="Status" Width="150" CellTemplate="{StaticResource StatusPillTemplate}" />
                                    </DataGrid.Columns>
                                </DataGrid>

                                <!-- ==================== LINEAR SECTION ==================== -->
                                <Border Grid.Row="3" Style="{StaticResource Style.BlotterSectionHeader.Linear}">
                                    <TextBlock Text="LINEAR (SPOT • FWD • SWAP • NDF)" 
                                               Style="{StaticResource Style.BlotterSectionHeaderText}"/>
                                </Border>

                                <DataGrid Grid.Row="4"
                                          x:Name="LinearGrid"
                                          Style="{StaticResource Style.BlotterDataGrid}"
                                          ItemsSource="{Binding LinearTradesView}"
                                          SelectedItem="{Binding SelectedLinearTrade, Mode=TwoWay}"
                                          ColumnHeaderStyle="{StaticResource Style.BlotterDataGridHeader}"
                                          CellStyle="{StaticResource Style.BlotterDataGridCell}"
                                          RowStyle="{StaticResource Style.BlotterDataGridRow.Linear}"
                                          AutoGenerateColumns="False">

                                    <DataGrid.ContextMenu>
                                        <ContextMenu Style="{StaticResource Style.BlotterContextMenu}">
                                            <MenuItem Header="Book Trade" 
                  Command="{Binding BookTradeCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Duplicate Trade" 
                  Command="{Binding DuplicateTradeCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Copy To Manual Input" 
                  Command="{Binding CopyToManualInputCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Book As Live Trade" 
                  Command="{Binding BookAsLiveTradeCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <Separator Style="{StaticResource Style.BlotterMenuSeparator}"/>
                                            <MenuItem Header="Cancel Calypso Trade" 
                  Command="{Binding CancelCalypsoTradeCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Delete Row" 
                  Command="{Binding DeleteRowCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <Separator Style="{StaticResource Style.BlotterMenuSeparator}"/>
                                            <MenuItem Header="Check If Trade Is Booked" 
                  Command="{Binding CheckIfBookedCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Open Error Log" 
                  Command="{Binding OpenErrorLogCommand}"
                  Style="{StaticResource Style.BlotterMenuItem}"/>
                                        </ContextMenu>
                                    </DataGrid.ContextMenu>

                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="TradeID" Binding="{Binding TradeId}" Width="120"/>
                                        <DataGridTextColumn Header="Counterpart" Binding="{Binding Counterparty}" Width="100"/>
                                        <DataGridTextColumn Header="Ccy Pair" Binding="{Binding CcyPair}" Width="80"/>
                                        <DataGridTextColumn Header="Buy/Sell" Binding="{Binding BuySell}" Width="70"/>
                                        <DataGridTextColumn Header="Notional" 
                                                            Binding="{Binding Notional, StringFormat=N0}"
                                                            CellStyle="{StaticResource Style.BlotterDataGridCell.Numeric}"
                                                            HeaderStyle="{StaticResource Style.BlotterDataGridHeader.Numeric}"
                                                            Width="90"/>
                                        <DataGridTextColumn Header="Notional Ccy" Binding="{Binding NotionalCcy}" Width="100"/>
                                        <DataGridTextColumn Header="Hedge Rate" 
                                                            Binding="{Binding HedgeRate, StringFormat=F4}" 
                                                            CellStyle="{StaticResource Style.BlotterDataGridCell.Numeric}"
                                                            HeaderStyle="{StaticResource Style.BlotterDataGridHeader.Numeric}"
                                                            Width="95"/>
                                        <DataGridTextColumn Header="Hedge Type" Binding="{Binding HedgeType}" Width="95"/>
                                        <DataGridTextColumn Header="Settlement Date" Binding="{Binding SettlementDate, StringFormat=yyyy-MM-dd}" Width="120"/>
                                        <DataGridTextColumn Header="Book Calypso" Binding="{Binding CalypsoPortfolio}" Width="110"/>
                                        <DataGridTextColumn Header="Book MX3" Binding="{Binding PortfolioMx3}" Width="110"/>
                                        <DataGridTextColumn Header="Trader" Binding="{Binding Trader}" Width="80"/>
                                        <DataGridTemplateColumn Header="Status" Width="150" CellTemplate="{StaticResource StatusPillTemplate}" />
                                    </DataGrid.Columns>

                                </DataGrid>
                            </Grid>






                            <!-- Column separator -->
                            <Border Grid.Column="1" Background="{StaticResource Brush.BorderSoft}"/>

                            
                            
                            
                            
                            <!-- RIGHT: Detail -->
                            <Border Grid.Column="2"
        Background="Transparent"
        Padding="12">

                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>

                                    <!-- Tabs -->
                                    <Border Style="{StaticResource Style.BlotterTabContainer}">

                                        <StackPanel Orientation="Horizontal">

                                            <RadioButton x:Name="TabSummary"
                             GroupName="DetailTabs"
                             IsChecked="True"
                             Style="{StaticResource DetailTabRadioStyle}"
                             Content="Summary"/>

                                            <RadioButton x:Name="TabEconomics"
                             GroupName="DetailTabs"
                             Style="{StaticResource DetailTabRadioStyle}"
                             Content="Economics"/>

                                            <RadioButton x:Name="TabRouting"
                             GroupName="DetailTabs"
                             Style="{StaticResource DetailTabRadioStyle}"
                             Content="Routing"/>

                                            <RadioButton x:Name="TabRegulatory"
                             GroupName="DetailTabs"
                             Style="{StaticResource DetailTabRadioStyle}"
                             Content="Regulatory"/>
                                            
                                        </StackPanel>
                                    </Border>

                                    <!-- Pages -->
                                    <Grid Grid.Row="1" Margin="0,12,0,0">

                                        <!-- SUMMARY PAGE -->
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ScrollViewer.Style>
                                                <Style TargetType="{x:Type ScrollViewer}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsChecked, ElementName=TabSummary}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ScrollViewer.Style>

                                            <StackPanel>

                                                <!-- TRADE SUMMARY card -->
                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="TRADE SUMMARY" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="120"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>

                                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="TradeID" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTrade.TradeId}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Source" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedTrade.Counterparty}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="2" Grid.Column="0" Text="MessageKey" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedTrade.TradeId}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Instrument" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding SelectedTrade.CcyPair}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Product" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding SelectedTrade.Product}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="5" Grid.Column="0" Text="Side" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding SelectedTrade.BuySell}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="6" Grid.Column="0" Text="Notional" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding SelectedTrade.Notional, StringFormat=N0}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="7" Grid.Column="0" Text="Price" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="7" Grid.Column="1" Text="{Binding SelectedTrade.Premium, StringFormat=N2}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="8" Grid.Column="0" Text="TradeTime" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="8" Grid.Column="1" Text="{Binding SelectedTrade.Time, StringFormat='yyyy-MM-dd HH:mm:ss'}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                        </Grid>
                                                    </StackPanel>
                                                </Border>

                                                <!-- WORKFLOW card -->
                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="WORKFLOW" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <WrapPanel>
                                                            <Border Style="{StaticResource Style.BlotterChip.Success}">
                                                                <TextBlock Text="Ingested" Style="{StaticResource Style.BlotterChipText}"/>
                                                            </Border>
                                                            <Border Style="{StaticResource Style.BlotterChip.Success}">
                                                                <TextBlock Text="Normalized" Style="{StaticResource Style.BlotterChipText}"/>
                                                            </Border>
                                                            <Border Style="{StaticResource Style.BlotterChip.Warning}">
                                                                <TextBlock Text="MX3 link: pending" Style="{StaticResource Style.BlotterChipText}"/>
                                                            </Border>
                                                            <Border Style="{StaticResource Style.BlotterChip.Info}">
                                                                <TextBlock Text="Audit: 4 events" Style="{StaticResource Style.BlotterChipText}"/>
                                                            </Border>
                                                        </WrapPanel>
                                                    </StackPanel>
                                                </Border>

                                            </StackPanel>
                                        </ScrollViewer>

                                        <!-- ECONOMICS PAGE -->
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ScrollViewer.Style>
                                                <Style TargetType="{x:Type ScrollViewer}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsChecked, ElementName=TabEconomics}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ScrollViewer.Style>

                                            <StackPanel>
                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="ECONOMICS" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="120"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>

                                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="CcyPair" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTrade.CcyPair}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="SettleCcy" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedTrade.NotionalCcy}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="2" Grid.Column="0" Text="ValueDate" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedTrade.SettlementDate, StringFormat=yyyy-MM-dd, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Strike" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding SelectedTrade.Strike, StringFormat=F4, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Expiry" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding SelectedTrade.ExpiryDate, StringFormat=yyyy-MM-dd, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                        </Grid>

                                                        <TextBlock Margin="0,10,0,0"
                               Foreground="{StaticResource Brush.TextMuted}"
                               Text="Idé: Här visar du allt som annars skulle bli 40+ kolumner i gridet."/>
                                                    </StackPanel>
                                                </Border>
                                            </StackPanel>
                                        </ScrollViewer>

                                        <!-- ROUTING PAGE -->
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ScrollViewer.Style>
                                                <Style TargetType="{x:Type ScrollViewer}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsChecked, ElementName=TabRouting}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ScrollViewer.Style>

                                            <StackPanel>

                                                <!-- D2.2D: Error Message -->
                                                <Border Background="#1AEF4444"
            BorderBrush="#EF4444"
            BorderThickness="1"
            CornerRadius="{StaticResource Radius.Button}"
            Padding="10"
            Margin="0,0,0,10"
            Visibility="{Binding DetailsLastError, Converter={StaticResource NullToCollapsed}}">
                                                    <TextBlock Text="{Binding DetailsLastError}" 
                   Foreground="#EF4444" 
                   TextWrapping="Wrap"
                   FontSize="11"/>
                                                </Border>

                                                <!-- D2.2D: System Links Card -->
                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="ROUTING / SYSTEM LINKS" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <!-- D2.2D: Bind till SelectedTradeSystemLinks med utökade fält -->
                                                        <ItemsControl ItemsSource="{Binding SelectedTradeSystemLinks}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Border Style="{StaticResource Style.BlotterSystemCard}">
                                                                        <Grid>
                                                                            <Grid.ColumnDefinitions>
                                                                                <ColumnDefinition Width="*"/>
                                                                                <ColumnDefinition Width="Auto"/>
                                                                            </Grid.ColumnDefinitions>
                                                                            <Grid.RowDefinitions>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                            </Grid.RowDefinitions>

                                                                            <!-- System name -->
                                                                            <TextBlock Grid.Row="0" Grid.Column="0" 
                                           Text="{Binding SystemCode}" 
                                           Style="{StaticResource Style.BlotterSystemName}"/>

                                                                            <!-- Status badge -->
                                                                            <Border Grid.Row="0" Grid.Column="1" Grid.RowSpan="2"
                                        Style="{StaticResource Style.BlotterStatusBadge}"
                                        Margin="0,0,0,0">
                                                                                <StackPanel Orientation="Horizontal">
                                                                                    <Ellipse Width="6" Height="6" 
                                                 Margin="0,0,6,0"
                                                 VerticalAlignment="Center">
                                                                                        <Ellipse.Style>
                                                                                            <Style TargetType="Ellipse">
                                                                                                <Setter Property="Fill" Value="{StaticResource Brush.TextMuted}"/>
                                                                                                <Style.Triggers>
                                                                                                    <DataTrigger Binding="{Binding Status}" Value="NEW">
                                                                                                        <Setter Property="Fill" Value="#3B82F6"/>
                                                                                                    </DataTrigger>
                                                                                                    <DataTrigger Binding="{Binding Status}" Value="BOOKED">
                                                                                                        <Setter Property="Fill" Value="#2DD4BF"/>
                                                                                                    </DataTrigger>
                                                                                                    <DataTrigger Binding="{Binding Status}" Value="PENDING">
                                                                                                        <Setter Property="Fill" Value="#FBBF24"/>
                                                                                                    </DataTrigger>
                                                                                                    <DataTrigger Binding="{Binding Status}" Value="REJECTED">
                                                                                                        <Setter Property="Fill" Value="#FB7185"/>
                                                                                                    </DataTrigger>
                                                                                                    <DataTrigger Binding="{Binding Status}" Value="PARTIAL">
                                                                                                        <Setter Property="Fill" Value="#FB923C"/>
                                                                                                    </DataTrigger>
                                                                                                </Style.Triggers>
                                                                                            </Style>
                                                                                        </Ellipse.Style>
                                                                                    </Ellipse>
                                                                                    <TextBlock Text="{Binding Status, Converter={StaticResource ProperCase}, TargetNullValue=Unknown}" 
           Style="{StaticResource Style.BlotterStatusBadgeText}"/>

                                                                                </StackPanel>
                                                                            </Border>

                                                                            <!-- SystemLinkId -->
                                                                            <TextBlock Grid.Row="1" Grid.Column="0"
                                           Style="{StaticResource Style.BlotterSystemCode}">
                                    <Run Text="SystemLinkId="/>
                                    <Run Text="{Binding SystemLinkId, Mode=OneWay}"/>
                                                                            </TextBlock>

                                                                            <!-- External TradeID -->
                                                                            <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,6,0,0">
                                                                                <Grid.ColumnDefinitions>
                                                                                    <ColumnDefinition Width="Auto"/>
                                                                                    <ColumnDefinition Width="*"/>
                                                                                </Grid.ColumnDefinitions>

                                                                                <TextBlock Grid.Column="0"
                                               Text="External TradeID:" 
                                               Foreground="{StaticResource Brush.TextMuted2}"
                                               FontSize="11"
                                               Margin="0,0,8,0"
                                               VerticalAlignment="Center"/>

                                                                                <TextBlock Grid.Column="1"
                                               Text="{Binding SystemTradeId, TargetNullValue=—}" 
                                               Foreground="{StaticResource Brush.TextMuted}"
                                               FontSize="11"
                                               FontFamily="{StaticResource Font.Mono}"
                                               VerticalAlignment="Center"
                                               TextWrapping="Wrap"/>
                                                                            </Grid>

                                                                            <!-- Portfolio -->
                                                                            <Grid Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,4,0,0">
                                                                                <Grid.ColumnDefinitions>
                                                                                    <ColumnDefinition Width="Auto"/>
                                                                                    <ColumnDefinition Width="*"/>
                                                                                </Grid.ColumnDefinitions>

                                                                                <TextBlock Grid.Column="0"
                                               Text="Portfolio:" 
                                               Foreground="{StaticResource Brush.TextMuted2}"
                                               FontSize="11"
                                               Margin="0,0,8,0"
                                               VerticalAlignment="Center"/>

                                                                                <TextBlock Grid.Column="1"
                                               Text="{Binding PortfolioCode, TargetNullValue=—}" 
                                               Foreground="{StaticResource Brush.Text}"
                                               FontSize="11"
                                               FontWeight="SemiBold"
                                               VerticalAlignment="Center"/>
                                                                            </Grid>

                                                                            <!-- Last Status timestamp -->
                                                                            <Grid Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,4,0,0">
                                                                                <Grid.ColumnDefinitions>
                                                                                    <ColumnDefinition Width="Auto"/>
                                                                                    <ColumnDefinition Width="*"/>
                                                                                </Grid.ColumnDefinitions>

                                                                                <TextBlock Grid.Column="0"
                                               Text="Last Status:" 
                                               Foreground="{StaticResource Brush.TextMuted2}"
                                               FontSize="11"
                                               Margin="0,0,8,0"
                                               VerticalAlignment="Center"/>

                                                                                <TextBlock Grid.Column="1"
                                               Text="{Binding LastStatusUtc, StringFormat='yyyy-MM-dd HH:mm:ss', TargetNullValue=—}" 
                                               Foreground="{StaticResource Brush.TextMuted}"
                                               FontSize="11"
                                               FontFamily="{StaticResource Font.Mono}"
                                               VerticalAlignment="Center"/>
                                                                            </Grid>

                                                                            <!-- Error message (conditional) -->
                                                                            <Border Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="2" 
                                        Margin="0,8,0,0"
                                        Background="#1AEF4444"
                                        BorderBrush="#EF4444"
                                        BorderThickness="1"
                                        CornerRadius="{StaticResource Radius.Button}"
                                        Padding="8,6"
                                        Visibility="{Binding LastError, Converter={StaticResource NullToCollapsed}}">
                                                                                <StackPanel Orientation="Horizontal">
                                                                                    <TextBlock Text="⚠ " 
                                                   Foreground="#EF4444"
                                                   FontSize="11"
                                                   Margin="0,0,4,0"
                                                   VerticalAlignment="Top"/>
                                                                                    <TextBlock Text="{Binding LastError}" 
                                                   Foreground="#EF4444"
                                                   FontSize="11"
                                                   TextWrapping="Wrap"
                                                   VerticalAlignment="Center"/>
                                                                                </StackPanel>
                                                                            </Border>

                                                                        </Grid>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>

                                                        <!-- Empty state -->
                                                        <TextBlock Text="No system links found"
                       Foreground="{StaticResource Brush.TextMuted2}"
                       FontStyle="Italic"
                       Margin="10"
                       HorizontalAlignment="Center">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding SelectedTradeSystemLinks.Count}" Value="0">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>

                                                    </StackPanel>
                                                </Border>

                                                <!-- D2.2D: WORKFLOW EVENTS card -->
                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="LATEST WORKFLOW EVENTS" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <!-- D2.2D: Bind till SelectedTradeWorkflowEvents -->
                                                        <ItemsControl ItemsSource="{Binding SelectedTradeWorkflowEvents}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Border Style="{StaticResource Style.BlotterEventRow}">
                                                                        <Grid>
                                                                            <Grid.RowDefinitions>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                            </Grid.RowDefinitions>

                                                                            <Grid.ColumnDefinitions>
                                                                                <ColumnDefinition Width="Auto"/>
                                                                                <!-- Timestamp -->
                                                                                <ColumnDefinition Width="12"/>
                                                                                <!-- Spacing -->
                                                                                <ColumnDefinition Width="Auto"/>
                                                                                <!-- Icon -->
                                                                                <ColumnDefinition Width="12"/>
                                                                                <!-- Spacing -->
                                                                                <ColumnDefinition Width="*"/>
                                                                                <!-- Content -->
                                                                            </Grid.ColumnDefinitions>

                                                                            <!-- Timestamp - TA BORT Style, sätt properties direkt -->
                                                                            <TextBlock Grid.Row="0" Grid.Column="0"
                               Text="{Binding TimestampUtc, StringFormat='HH:mm:ss'}"
                               FontFamily="{StaticResource Font.Mono}"
                               FontSize="11"
                               Foreground="{StaticResource Brush.TextMuted2}"
                               VerticalAlignment="Center"
                               Margin="0"/>

                                                                            <!-- Event Type Icon -->
                                                                            <TextBlock Grid.Row="0" Grid.Column="2"
                               Text="{Binding EventType, Converter={StaticResource EventTypeToIcon}}"
                               FontSize="14"
                               Foreground="{Binding EventType, Converter={StaticResource EventTypeToColor}}"
                               VerticalAlignment="Center"
                               Margin="0"/>

                                                                            <!-- Event Type + System Code Badge -->
                                                                            <StackPanel Grid.Row="0" Grid.Column="4" 
                                Orientation="Horizontal" 
                                VerticalAlignment="Center">

                                                                                <TextBlock Text="{Binding EventType}" 
                                   FontSize="13"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource Brush.Text}"
                                   VerticalAlignment="Center"
                                   Margin="0"/>

                                                                                <!-- System Code badge -->
                                                                                <Border Background="#1A64748B"
                                BorderBrush="#64748B"
                                BorderThickness="1"
                                CornerRadius="4"
                                Padding="6,2"
                                Margin="8,0,0,0"
                                VerticalAlignment="Center">
                                                                                    <TextBlock Text="{Binding SystemCode}" 
                                       FontSize="10"
                                       FontFamily="{StaticResource Font.Mono}"
                                       Foreground="{StaticResource Brush.TextMuted}"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"/>
                                                                                </Border>
                                                                            </StackPanel>

                                                                            <!-- Details (bullet list) -->
                                                                            <ItemsControl Grid.Row="1" Grid.Column="4"
                                  ItemsSource="{Binding Details, Converter={StaticResource DetailsToLines}}"
                                  Margin="0,6,0,0">
                                                                                <ItemsControl.ItemTemplate>
                                                                                    <DataTemplate>
                                                                                        <TextBlock Text="{Binding}"
                                           FontSize="11"
                                           Foreground="{StaticResource Brush.TextMuted}"
                                           Margin="0,0,0,2"
                                           TextWrapping="Wrap"/>
                                                                                    </DataTemplate>
                                                                                </ItemsControl.ItemTemplate>
                                                                            </ItemsControl>

                                                                        </Grid>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>

                                                        <!-- Empty state -->
                                                        <TextBlock Text="No workflow events found"
                       Foreground="{StaticResource Brush.TextMuted2}"
                       FontStyle="Italic"
                       Margin="10"
                       HorizontalAlignment="Center">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding SelectedTradeWorkflowEvents.Count}" Value="0">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>

                                                    </StackPanel>
                                                </Border>

                                            </StackPanel>


                                        </ScrollViewer>

                                        <!-- REGULATORY PAGE -->
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ScrollViewer.Style>
                                                <Style TargetType="{x:Type ScrollViewer}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsChecked, ElementName=TabRegulatory}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ScrollViewer.Style>

                                            <StackPanel>

                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="REGULATORY FIELDS" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="120"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>

                                                            </Grid.RowDefinitions>

                                                            <!-- Trader ID - finns som Trader property -->
                                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Trader ID" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTrade.Trader, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- Trader Name - från lookup (N/A tills vidare) -->
                                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Trader Name" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="N/A" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- Execution Time - finns som Time property -->
                                                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Execution Time" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedTrade.Time, StringFormat='yyyy-MM-dd HH:mm:ss', TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- MIC - finns nu! -->
                                                            <TextBlock Grid.Row="3" Grid.Column="0" Text="MIC" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding SelectedTrade.Mic, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- TVTIC - finns nu! -->
                                                            <TextBlock Grid.Row="4" Grid.Column="0" Text="TVTIC" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding SelectedTrade.Tvtic, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- ISIN - finns nu! -->
                                                            <TextBlock Grid.Row="5" Grid.Column="0" Text="ISIN" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding SelectedTrade.Isin, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- Inv. Decision ID - finns nu! -->
                                                            <TextBlock Grid.Row="6" Grid.Column="0" Text="Inv. Decision ID" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding SelectedTrade.InvDecisionId, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- Inv. Decision Name - från lookup (N/A) -->
                                                            <TextBlock Grid.Row="7" Grid.Column="0" Text="Inv. Decision Name" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="7" Grid.Column="1" Text="N/A" Style="{StaticResource Style.BlotterRightValue}"/>


                                                        </Grid>
                                                    </StackPanel>
                                                </Border>



                                            </StackPanel>
                                        </ScrollViewer>

                                    </Grid>


                                </Grid>
                            </Border>



                        </Grid>

                    </Grid>
                </Border>

            </Grid>
            
              
            
        </Border>

        <!-- STATUSRAD - diskret längst ner -->
        <Border Background="{StaticResource Brush.Panel2}"
                BorderBrush="{StaticResource Brush.BorderSoft}"
                BorderThickness="0,1,0,0"
                Padding="8,4"
                VerticalAlignment="Bottom">

            <Grid>
                <!-- Normal state - dold när IsStale=True -->
                <TextBlock FontSize="10" 
                           Foreground="{StaticResource Brush.TextMuted2}"
                           HorizontalAlignment="Right"
                           x:Name="NormalStatus">
                    <Run Text="Last refresh: "/>
                    <Run Text="{Binding LastRefreshUtc, Mode=OneWay, StringFormat='HH:mm:ss', TargetNullValue='—'}"/>
                    <Run Text=" ("/>
                    <Run Text="{Binding LastRefreshDuration.TotalMilliseconds, Mode=OneWay, StringFormat='F0', TargetNullValue='—'}"/>
                    <Run Text="ms)"/>
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsStale}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <!-- Error state - synlig när IsStale=True -->
                <TextBlock FontSize="10" 
                           Foreground="#EF4444"
                           HorizontalAlignment="Right"
                           x:Name="ErrorStatus">
                    <Run Text="⚠ "/>
                    <Run Text="Last refresh: "/>
                    <Run Text="{Binding LastRefreshUtc, Mode=OneWay, StringFormat='HH:mm:ss', TargetNullValue='—'}"/>
                    <Run Text=" — "/>
                    <Run Text="{Binding LastError, Mode=OneWay}"/>
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsStale}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </Grid>

        </Border>

    </Grid>
</UserControl>
