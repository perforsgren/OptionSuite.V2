<UserControl x:Class="OptionSuite.Blotter.Wpf.Views.BlotterRootView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:OptionSuite.Blotter.Wpf.Converters">

    <UserControl.InputBindings>
        <KeyBinding Key="B" Modifiers="Control" Command="{Binding BulkBookCommand}"/>
    </UserControl.InputBindings>


    <UserControl.Resources>

        <!-- Converters -->
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>
        <converters:BoolToYesNoConverter x:Key="BoolToYesNoConverter"/>
        <converters:NullToCollapsedConverter x:Key="NullToCollapsed"/>
        <converters:NullToVisibleConverter x:Key="NullToVisible"/>
        <converters:DetailsToLinesConverter x:Key="DetailsToLines"/>
        <converters:EventTypeToIconConverter x:Key="EventTypeToIcon"/>
        <converters:EventTypeToColorConverter x:Key="EventTypeToColor"/>
        <converters:SystemStatusToColorConverter x:Key="SystemStatusToColor"/>
        <converters:NullToBoolConverter x:Key="NullToBoolConverter"/>
        <converters:UtcToLocalTimeConverter x:Key="UtcToLocalTime"/>

        <!-- =========================================================
             SOFT FOG (token-baserad)
             Bygger “dimmad” top-to-bottom känsla över hela contentytan.
             Endast tokens: Panel/Panel2/BorderSoft/Glow.Accent/Transparent.
             ========================================================= -->
        <LinearGradientBrush x:Key="Blotter.Brush.ContentFog" StartPoint="0,0" EndPoint="0,1">
            <!-- Lite ljusare uppe -->
            <GradientStop Color="{StaticResource Color.BorderSoft}" Offset="0.0"/>
            <!-- Dimmad blå ton -->
            <GradientStop Color="{StaticResource Color.Glow.Accent}" Offset="0.35"/>
            <!-- Ner mot panel -->
            <GradientStop Color="{StaticResource Color.Transparent}" Offset="1.0"/>
        </LinearGradientBrush>

        <!-- =========================================================
             Status-/filterstrip (kvar – ingen funktionalitet ändras)
             ========================================================= -->
        <Style x:Key="BlotterStripButtonBaseStyle" TargetType="Button">
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Margin" Value="0,0,8,0"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{StaticResource Brush.BorderSoft}"/>
            <Setter Property="Background" Value="{StaticResource Brush.Panel}"/>
            <Setter Property="Foreground" Value="{StaticResource Brush.TextMuted}"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{StaticResource Radius.Button}">
                            <ContentPresenter Margin="{TemplateBinding Padding}"
                                              VerticalAlignment="Center"
                                              HorizontalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="BlotterStripButtonActiveStyle"
               TargetType="Button"
               BasedOn="{StaticResource BlotterStripButtonBaseStyle}">
            <Setter Property="Foreground" Value="{StaticResource Brush.Text}"/>
            <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}"/>
            <Setter Property="Background" Value="{StaticResource Brush.Panel2}"/>
        </Style>

        <Style x:Key="BlotterStripCountBadgeStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource Brush.Panel2}"/>
            <Setter Property="BorderBrush" Value="{StaticResource Brush.BorderSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="{StaticResource Radius.Button}"/>
            <Setter Property="Padding" Value="8,1"/>
            <Setter Property="Margin" Value="8,0,0,0"/>
        </Style>

        <Style x:Key="BlotterStripCountTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Foreground" Value="{StaticResource Brush.TextMuted}"/>
        </Style>

        <!-- Combined Status + New badge - med Grid för alignment -->
        <DataTemplate x:Key="StatusPillTemplate">
            <Grid HorizontalAlignment="Left" Opacity="1.0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <!-- Status pill -->
                    <ColumnDefinition Width="8"/>
                    <!-- Margin -->
                    <ColumnDefinition Width="Auto"/>
                    <!-- New badge -->
                </Grid.ColumnDefinitions>

                <!-- Status pill -->
                <Border Grid.Column="0"
                BorderBrush="{StaticResource Brush.BorderSoft}"
                BorderThickness="1"
                Background="{StaticResource Blotter.Brush.GlassPill}"
                CornerRadius="{StaticResource Radius.Button}"
                Padding="10,3"
                MinWidth="80">
                    <!-- Minsta bredd så alla status får samma space -->
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <Ellipse Width="7" Height="7" Margin="0,0,8,0" VerticalAlignment="Center">
                            <Ellipse.Style>
                                <Style TargetType="Ellipse">
                                    <Setter Property="Fill" Value="{StaticResource Brush.TextMuted}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Status}" Value="New">
                                            <Setter Property="Fill" Value="#3B82F6"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Booked">
                                            <Setter Property="Fill" Value="#2DD4BF"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Pending">
                                            <Setter Property="Fill" Value="#FBBF24"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Error">
                                            <Setter Property="Fill" Value="#EF4444"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Rejected">
                                            <Setter Property="Fill" Value="#FB7185"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Partial">
                                            <Setter Property="Fill" Value="#FB923C"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Ellipse.Style>
                        </Ellipse>

                        <TextBlock Text="{Binding Status}"
           Foreground="{StaticResource Brush.Text}"
           FontSize="12"
           VerticalAlignment="Center"/>

                    </StackPanel>
                </Border>

                <!-- New badge (Grid.Column="2" så den hamnar efter marginal) -->
                <Border Grid.Column="2"
                Style="{StaticResource NewBadgeBorderStyle}"
                VerticalAlignment="Center"
                Visibility="{Binding IsNew, Converter={StaticResource BoolToVisConverter}}">
                    <TextBlock Text="New" Style="{StaticResource NewBadgeTextStyle}"/>
                </Border>

            </Grid>
        </DataTemplate>




        <!-- =========================================================
             Detail tabs (högerpanelen) – oförändrat
             ========================================================= -->
        <Style x:Key="DetailTabButtonBaseStyle" TargetType="Button">
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Margin" Value="0,0,6,0"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource Brush.TextMuted}"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{StaticResource Radius.Button}">
                            <ContentPresenter Margin="{TemplateBinding Padding}"
                                              VerticalAlignment="Center"
                                              HorizontalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DetailTabButtonActiveStyle"
               TargetType="Button"
               BasedOn="{StaticResource DetailTabButtonBaseStyle}">
            <Setter Property="Foreground" Value="{StaticResource Brush.Text}"/>
            <Setter Property="Background" Value="{StaticResource Brush.Panel2}"/>
            <Setter Property="BorderBrush" Value="{StaticResource Brush.BorderSoft}"/>
        </Style>



    </UserControl.Resources>

    <Grid Margin="{StaticResource Thickness.WindowPadding}">

        <Border Background="{StaticResource Brush.Panel}"
                BorderBrush="{StaticResource Brush.Border}"
                BorderThickness="1"
                CornerRadius="0">

            <Grid Margin="{StaticResource Thickness.WindowPadding}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Title -->
                <StackPanel Grid.Row="0">
                    <TextBlock Text="{Binding Title}"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource Brush.Text}" />

                    <TextBlock Text="{Binding Subtitle}"
                               Margin="0,6,0,0"
                               FontSize="12"
                               Foreground="{StaticResource Brush.TextMuted}" />
                </StackPanel>

                <!-- Main area -->
                <Border Grid.Row="1"
                        Margin="0,14,0,0"
                        BorderBrush="{StaticResource Brush.BorderSoft}"
                        BorderThickness="1"
                        CornerRadius="{StaticResource Radius.Button}"
                        Background="{StaticResource Brush.Panel2}">

                    <!-- Gemensam “fog” över ALLT (toolbar + filter + grid + detail) -->
                    <Grid Background="{StaticResource Blotter.Brush.ContentFog}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- =========================================================
                             TOOLBAR + FILTER STRIP
                             Låt fog ligga under; använd bara separators.
                             ========================================================= -->
                        <Grid Grid.Row="0" Background="Transparent">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="1"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="1"/>
                            </Grid.RowDefinitions>

                            <!-- Toolbar -->
                            <Grid Grid.Row="0" Background="Transparent">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Left actions -->
                                <StackPanel Orientation="Horizontal"
            Margin="12"
            VerticalAlignment="Center">

                                    <Button Command="{Binding BulkBookCommand}" 
            Margin="0,0,0,0"
            Cursor="Hand">
                                        <Button.Style>
                                            <Style TargetType="Button" BasedOn="{StaticResource Style.BlotterToolbarButton}">
                                                <Setter Property="Background" Value="#1A2DD4BF"/>
                                                <Setter Property="BorderBrush" Value="#2DD4BF"/>
                                                <Setter Property="Foreground" Value="#2DD4BF"/>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#332DD4BF"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <TextBlock Text="▶"
                       Margin="0,1,8,0"
                       FontSize="11"
                       Foreground="#2DD4BF"
                       VerticalAlignment="Center"/>
                                            <TextBlock Text="Book" VerticalAlignment="Center"/>
                                            <Border Style="{StaticResource Style.BlotterShortcutPill}" Margin="10,0,0,0">
                                                <TextBlock Style="{StaticResource Style.BlotterShortcutPillText}" Text="Ctrl+B"/>
                                            </Border>
                                        </StackPanel>
                                    </Button>

                                    <Button Style="{StaticResource Style.BlotterToolbarButton}"
            Command="{Binding RefreshCommand}"
            Margin="10,0,0,0">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="6"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- Pulserande grön prick -->
                                            <Ellipse Grid.Column="0"
                     Width="6" 
                     Height="6" 
                     Fill="#2DD4BF"
                     VerticalAlignment="Center"
                     Margin="0,1,0,0">
                                                <Ellipse.Style>
                                                    <Style TargetType="Ellipse">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsBusy}" Value="False">
                                                                <DataTrigger.EnterActions>
                                                                    <BeginStoryboard>
                                                                        <Storyboard RepeatBehavior="Forever">
                                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                             From="1.0" To="0.3" Duration="0:0:1.2"
                                                             AutoReverse="True"/>
                                                                        </Storyboard>
                                                                    </BeginStoryboard>
                                                                </DataTrigger.EnterActions>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Ellipse.Style>
                                            </Ellipse>

                                            <!-- Text -->
                                            <TextBlock Grid.Column="2" 
                       Text="Refresh"
                       VerticalAlignment="Center"/>
                                        </Grid>
                                    </Button>

                                    <!-- NY: Separator mellan actions och input -->
                                    <Border Style="{StaticResource Style.BlotterToolbarSeparator}"/>

                                    <Button Style="{StaticResource Style.BlotterToolbarButton}"
            Content="Manual Input"
            Margin="0,0,0,0"/>
                                    <!-- Ändrat margin från 10,0,0,0 -->

                                </StackPanel>

                                <!-- Right tools -->
                                <StackPanel Grid.Column="1"
            Orientation="Horizontal"
            Margin="12"
            VerticalAlignment="Center">

                                    <!-- Search -->
                                    <Border CornerRadius="{StaticResource Radius.Button}"
            BorderBrush="{StaticResource Brush.Border}"
            BorderThickness="1"
            Background="{StaticResource Brush.PanelChromeTitle}"
            Padding="10,7"
            MinWidth="300">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <TextBlock Text="Search"
                       Foreground="{StaticResource Brush.TextMuted}"
                       VerticalAlignment="Center"/>

                                            <TextBox Grid.Column="1"
                     Margin="10,0"
                     Background="Transparent"
                     BorderThickness="0"
                     Foreground="{StaticResource Brush.Text}"
                     FontSize="12"
                     VerticalContentAlignment="Center"/>

                                            <Border Grid.Column="2"
                    CornerRadius="7"
                    BorderBrush="{StaticResource Brush.BorderSoft}"
                    BorderThickness="1"
                    Background="{StaticResource Brush.PanelChromeTitle}"
                    Padding="6,2"
                    VerticalAlignment="Center">
                                                <TextBlock Text="Ctrl+F"
                           FontFamily="{StaticResource Font.Mono}"
                           FontSize="11"
                           Foreground="{StaticResource Brush.TextMuted}"/>
                                            </Border>
                                        </Grid>
                                    </Border>

                                    <!-- NY: Separator mellan search och settings -->
                                    <Border Style="{StaticResource Style.BlotterToolbarSeparator}"/>

                                    <Button Style="{StaticResource Style.BlotterToolbarButton}"
            Content="Columns"
            Margin="0,0,10,0"/>
                                    <!-- Ändrat margin från 10,0,0,0 -->

                                    <Button Style="{StaticResource Style.BlotterToolbarButton}"
            Content="Settings"
            Margin="0,0,0,0"/>
                                    <!-- Ändrat margin från 10,0,0,0 -->
                                </StackPanel>

                                <!-- Right tools -->
                                <StackPanel Grid.Column="1"
            Orientation="Horizontal"
            Margin="12"
            VerticalAlignment="Center">

                                    <!-- Search -->
                                    <Border CornerRadius="{StaticResource Radius.Button}"
            BorderBrush="{StaticResource Brush.Border}"
            BorderThickness="1"
            Background="{StaticResource Brush.PanelChromeTitle}"
            Padding="10,7"
            MinWidth="300">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <TextBlock Text="Search"
                       Foreground="{StaticResource Brush.TextMuted}"
                       VerticalAlignment="Center"/>

                                            <TextBox Grid.Column="1"
                     Margin="10,0"
                     Background="Transparent"
                     BorderThickness="0"
                     Foreground="{StaticResource Brush.Text}"
                     FontSize="12"
                     VerticalContentAlignment="Center"/>

                                            <Border Grid.Column="2"
                    CornerRadius="7"
                    BorderBrush="{StaticResource Brush.BorderSoft}"
                    BorderThickness="1"
                    Background="{StaticResource Brush.PanelChromeTitle}"
                    Padding="6,2"
                    VerticalAlignment="Center">
                                                <TextBlock Text="Ctrl+F"
                           FontFamily="{StaticResource Font.Mono}"
                           FontSize="11"
                           Foreground="{StaticResource Brush.TextMuted}"/>
                                            </Border>
                                        </Grid>
                                    </Border>

                                    <!-- NY: Separator mellan search och settings -->
                                    <Border Style="{StaticResource Style.BlotterToolbarSeparator}"/>

                                    <Button Style="{StaticResource Style.BlotterToolbarButton}"
            Content="Columns"
            Margin="0,0,10,0"/>

                                    <Button Style="{StaticResource Style.BlotterToolbarButton}"
            Content="Settings"
            Margin="0,0,0,0"/>
                                </StackPanel>

                            </Grid>

                            <!-- Separator toolbar -> filter -->
                            <Border Grid.Row="1" Background="{StaticResource Brush.Border}"/>

                            <!-- Filter strip -->
                            <Border Grid.Row="2" Background="Transparent">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Status filters (vänster) -->
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="12,10">

                                        <RadioButton GroupName="BlotterStatusFilter"
             Style="{StaticResource Style.BlotterStripToggle}"
             IsChecked="True"
             Command="{Binding SetFilterAllCommand}">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock Text="All" Style="{StaticResource Style.BlotterStripLabel}" VerticalAlignment="Center"/>
                                                <Border Margin="8,0,0,0">
                                                    <Border.Style>
                                                        <Style TargetType="Border" BasedOn="{StaticResource Style.BlotterCountPill}">
                                                            <Setter Property="Background" Value="#0AFFFFFF"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=RadioButton}, Path=IsChecked}" Value="True">
                                                                    <!-- ✅ Grå/vit istället för blå -->
                                                                    <Setter Property="Background" Value="#1AFFFFFF"/>
                                                                    <Setter Property="BorderBrush" Value="#64748B"/>
                                                                    <!-- Slate gray -->
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <TextBlock Text="{Binding TotalTrades}" VerticalAlignment="Center">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock" BasedOn="{StaticResource Style.BlotterCountPillText}">
                                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=RadioButton}, Path=IsChecked}" Value="True">
                                                                        <!-- ✅ Ljusare grå text -->
                                                                        <Setter Property="Foreground" Value="#94A3B8"/>
                                                                        <!-- Slate 400 -->
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Border>
                                            </StackPanel>
                                        </RadioButton>

                                        <!-- 4. Sök-fältet - mer framträdande (subtle border + luftigare padding) -->
                                        <RadioButton GroupName="BlotterStatusFilter"
                         Style="{StaticResource Style.BlotterStripToggle}"
                         Margin="6,0,0,0"
                         Command="{Binding SetFilterNewCommand}">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock Text="New" Style="{StaticResource Style.BlotterStripLabel}" VerticalAlignment="Center"/>
                                                <Border Margin="8,0,0,0">
                                                    <Border.Style>
                                                        <Style TargetType="Border" BasedOn="{StaticResource Style.BlotterCountPill}">
                                                            <Setter Property="Background" Value="#0AFFFFFF"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=RadioButton}, Path=IsChecked}" Value="True">
                                                                    <Setter Property="Background" Value="#1A3B82F6"/>
                                                                    <Setter Property="BorderBrush" Value="#3B82F6"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <TextBlock Text="{Binding NewCount}">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock" BasedOn="{StaticResource Style.BlotterCountPillText}">
                                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=RadioButton}, Path=IsChecked}" Value="True">
                                                                        <Setter Property="Foreground" Value="#3B82F6"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Border>
                                            </StackPanel>
                                        </RadioButton>

                                        <RadioButton GroupName="BlotterStatusFilter"
                         Style="{StaticResource Style.BlotterStripToggle}"
                         Margin="6,0,0,0"
                         Command="{Binding SetFilterPendingCommand}">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock Text="Pending" Style="{StaticResource Style.BlotterStripLabel}" VerticalAlignment="Center"/>
                                                <Border Margin="8,0,0,0">
                                                    <Border.Style>
                                                        <Style TargetType="Border" BasedOn="{StaticResource Style.BlotterCountPill}">
                                                            <Setter Property="Background" Value="#0AFFFFFF"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=RadioButton}, Path=IsChecked}" Value="True">
                                                                    <Setter Property="Background" Value="#1AFBBF24"/>
                                                                    <Setter Property="BorderBrush" Value="#FBBF24"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <TextBlock Text="{Binding PendingCount}">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock" BasedOn="{StaticResource Style.BlotterCountPillText}">
                                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=RadioButton}, Path=IsChecked}" Value="True">
                                                                        <Setter Property="Foreground" Value="#FBBF24"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Border>
                                            </StackPanel>
                                        </RadioButton>

                                        <RadioButton GroupName="BlotterStatusFilter"
                         Style="{StaticResource Style.BlotterStripToggle}"
                         Margin="6,0,0,0"
                         Command="{Binding SetFilterBookedCommand}">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock Text="Booked" Style="{StaticResource Style.BlotterStripLabel}" VerticalAlignment="Center"/>
                                                <Border Margin="8,0,0,0">
                                                    <Border.Style>
                                                        <Style TargetType="Border" BasedOn="{StaticResource Style.BlotterCountPill}">
                                                            <Setter Property="Background" Value="#0AFFFFFF"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=RadioButton}, Path=IsChecked}" Value="True">
                                                                    <Setter Property="Background" Value="#1A2DD4BF"/>
                                                                    <Setter Property="BorderBrush" Value="#2DD4BF"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <TextBlock Text="{Binding BookedCount}">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock" BasedOn="{StaticResource Style.BlotterCountPillText}">
                                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=RadioButton}, Path=IsChecked}" Value="True">
                                                                        <Setter Property="Foreground" Value="#2DD4BF"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Border>
                                            </StackPanel>
                                        </RadioButton>

                                        <RadioButton GroupName="BlotterStatusFilter"
                         Style="{StaticResource Style.BlotterStripToggle}"
                         Margin="6,0,0,0"
                         Command="{Binding SetFilterErrorsCommand}">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock Text="Errors" Style="{StaticResource Style.BlotterStripLabel}" VerticalAlignment="Center"/>
                                                <Border Margin="8,0,0,0">
                                                    <Border.Style>
                                                        <Style TargetType="Border" BasedOn="{StaticResource Style.BlotterCountPill}">
                                                            <Setter Property="Background" Value="#0AFFFFFF"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=RadioButton}, Path=IsChecked}" Value="True">
                                                                    <Setter Property="Background" Value="#1AEF4444"/>
                                                                    <Setter Property="BorderBrush" Value="#EF4444"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <TextBlock Text="{Binding ErrorCount}">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock" BasedOn="{StaticResource Style.BlotterCountPillText}">
                                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=RadioButton}, Path=IsChecked}" Value="True">
                                                                        <Setter Property="Foreground" Value="#EF4444"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Border>
                                            </StackPanel>
                                        </RadioButton>

                                    </StackPanel>

                                    <!-- Quick filters (höger) -->
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="12,10">

                                        <!-- 6. Quick filters - bättre visuell feedback (subtil glow på IsChecked) -->
                                        <CheckBox Style="{StaticResource Style.BlotterQuickFilter}"
                      IsChecked="{Binding FilterMyTradesOnly}"
                      Content="My trades">
                                            <CheckBox.Resources>
                                                <!-- 7. Micro-interaktioner: lägg till smooth transition på hover/checked -->
                                                <Style TargetType="CheckBox" BasedOn="{StaticResource Style.BlotterQuickFilter}">
                                                    <Style.Triggers>
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Setter Property="Background" Value="#1A3B82F6"/>
                                                            <Setter Property="Foreground" Value="#3B82F6"/>
                                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                                        </Trigger>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#0AFFFFFF"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </CheckBox.Resources>
                                        </CheckBox>

                                        <CheckBox Style="{StaticResource Style.BlotterQuickFilter}"
                      IsChecked="{Binding FilterTodayOnly}"
                      Content="Today"
                      Margin="6,0,0,0">
                                            <CheckBox.Resources>
                                                <Style TargetType="CheckBox" BasedOn="{StaticResource Style.BlotterQuickFilter}">
                                                    <Style.Triggers>
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Setter Property="Background" Value="#1A3B82F6"/>
                                                            <Setter Property="Foreground" Value="#3B82F6"/>
                                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                                        </Trigger>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#0AFFFFFF"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </CheckBox.Resources>
                                        </CheckBox>

                                        <!-- Auto-book toggle (special styling med grön accent) -->
                                        <CheckBox IsChecked="{Binding AutoBookEnabled}"
                      Margin="6,0,0,0"
                      Cursor="Hand">
                                            <CheckBox.Style>
                                                <Style TargetType="CheckBox" BasedOn="{StaticResource Style.BlotterQuickFilter}">
                                                    <Style.Triggers>
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Setter Property="Foreground" Value="#10B981"/>
                                                            <Setter Property="Background" Value="#1A10B981"/>
                                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                                        </Trigger>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#0AFFFFFF"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </CheckBox.Style>
                                            <StackPanel Orientation="Horizontal">
                                                <Ellipse Width="6" Height="6" 
                             Fill="#10B981" 
                             Margin="0,1,6,0"
                             VerticalAlignment="Center" 
                             Visibility="{Binding AutoBookEnabled, Converter={StaticResource BoolToVisConverter}}"/>
                                                <TextBlock Text="Auto-book"/>
                                            </StackPanel>
                                        </CheckBox>

                                    </StackPanel>
                                </Grid>
                            </Border>


                            <!-- Separator filter -> content -->
                            <Border Grid.Row="3" Background="{StaticResource Brush.Border}"/>
                        </Grid>

                        <!-- =========================================================
                             CONTENT (Grid + Detail)
                             Fog ligger under, så här håller vi ytor transparenta.
                             ========================================================= -->
                        <Grid Grid.Row="1" Background="Transparent">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="1"/>
                                <ColumnDefinition Width="360"/>
                            </Grid.ColumnDefinitions>

                            <Grid>
                                <Grid.RowDefinitions>
                                    <!-- Section header för options -->
                                    <RowDefinition Height="Auto"/>
                                    <!-- Options grid -->
                                    <RowDefinition Height="*"/>
                                    <!-- Gap mellan grids -->
                                    <RowDefinition Height="12"/>
                                    <!-- Section header för linear -->
                                    <RowDefinition Height="Auto"/>
                                    <!-- Linear grid -->
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- ==================== OPTIONS SECTION ==================== -->
                                <Border Grid.Row="0" Style="{StaticResource Style.BlotterSectionHeader.Options}">
                                    <TextBlock Text="OPTIONS (VANILLA • NDO)" Style="{StaticResource Style.BlotterSectionHeaderText}"/>
                                </Border>

                                <!-- OPTIONS GRID - bind till SelectedOptionTrade -->
                                <DataGrid Grid.Row="1"
                                          x:Name="OptionGrid"
                                          Style="{StaticResource Style.BlotterDataGrid}"
                                          ItemsSource="{Binding OptionTradesView}"
                                          SelectedItem="{Binding SelectedOptionTrade, Mode=TwoWay}"
                                          ColumnHeaderStyle="{StaticResource Style.BlotterDataGridHeader}"
                                          CellStyle="{StaticResource Style.BlotterDataGridCell.Booked}"      
                                          RowStyle="{StaticResource Style.BlotterDataGridRow.Options}"
                                          AutoGenerateColumns="False"
                                          CanUserSortColumns="False">

                                    <DataGrid.ContextMenu>
                                        <ContextMenu Style="{StaticResource Style.BlotterContextMenu}">
                                            <MenuItem Header="Book Trade" 
                                                      Command="{Binding BookTradeCommand}"
                                                      Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Duplicate Trade" 
                                                      Command="{Binding DuplicateTradeCommand}"
                                                      Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <Separator Style="{StaticResource Style.BlotterMenuSeparator}"/>
                                            <MenuItem Header="Delete Row" 
                                                      Command="{Binding DeleteRowCommand}"
                                                      Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <Separator Style="{StaticResource Style.BlotterMenuSeparator}"/>
                                            <MenuItem Header="Check If Trade Is Booked" 
                                                      Command="{Binding CheckIfBookedCommand}"
                                                      Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Open Error Log" 
                                                      Command="{Binding OpenErrorLogCommand}"
                                                      Style="{StaticResource Style.BlotterMenuItem}"/>
                                        </ContextMenu>
                                    </DataGrid.ContextMenu>

                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="TradeID" Binding="{Binding TradeId}" Width="120" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Counterpart" Binding="{Binding Counterparty}" Width="110" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Ccy Pair" Binding="{Binding CcyPair}" Width="80" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Buy/Sell" Binding="{Binding BuySell}" Width="70" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Call/Put" Binding="{Binding CallPut}" Width="70" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Strike" 
                                                            Binding="{Binding Strike, StringFormat=F4}" 
                                                            Width="65"
                                                            CellStyle="{StaticResource Style.BlotterDataGridCell.Numeric}"
                                                            HeaderStyle="{StaticResource Style.BlotterDataGridHeader.Numeric}"
                                                            IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Expiry Date" Binding="{Binding ExpiryDate, StringFormat=yyyy-MM-dd}" Width="100" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Notional" 
                                                            Binding="{Binding Notional, StringFormat=N0}" 
                                                            Width="90"
                                                            CellStyle="{StaticResource Style.BlotterDataGridCell.Numeric}"
                                                            HeaderStyle="{StaticResource Style.BlotterDataGridHeader.Numeric}" 
                                                            IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Notional Ccy" Binding="{Binding NotionalCcy}" Width="100" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Premium" 
                                                            Binding="{Binding Premium, StringFormat=N2}" 
                                                            Width="90"
                                                            CellStyle="{StaticResource Style.BlotterDataGridCell.Numeric}"
                                                            HeaderStyle="{StaticResource Style.BlotterDataGridHeader.Numeric}" 
                                                            IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Premium Ccy" Binding="{Binding PremiumCcy}" Width="100" IsReadOnly="True"/>

                                        <!-- EDITABLE: Portfolio MX3 - Endast editerbar för Status="New" -->
                                        <DataGridTemplateColumn Header="Portfolio MX3" Width="120">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <ComboBox Style="{StaticResource Style.BlotterComboBox}"
                                                              ItemsSource="{Binding DataContext.PortfolioMx3Values, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                              SelectedItem="{Binding PortfolioMx3, UpdateSourceTrigger=PropertyChanged}"
                                                              ItemContainerStyle="{StaticResource Style.BlotterComboBoxItem}"
                                                              IsEnabled="{Binding CanEdit}"
                                                              SelectionChanged="OnPortfolioComboBox_SelectionChanged"
                                                              DropDownOpened="OnPortfolioComboBox_DropDownOpened"
                                                              DropDownClosed="OnPortfolioComboBox_DropDownClosed"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>

                                        <DataGridTextColumn Header="Trader" Binding="{Binding Trader}" Width="80" IsReadOnly="True"/>
                                        <DataGridTemplateColumn Header="Status" Width="150" CellTemplate="{StaticResource StatusPillTemplate}" CellStyle="{StaticResource Style.BlotterDataGridCell.Status}" IsReadOnly="True"/>

                                    </DataGrid.Columns>
                                </DataGrid>

                                <!-- ==================== LINEAR SECTION ==================== -->
                                <Border Grid.Row="3" Style="{StaticResource Style.BlotterSectionHeader.Linear}">
                                    <TextBlock Text="LINEAR (SPOT • FWD • SWAP • NDF)" 
                                               Style="{StaticResource Style.BlotterSectionHeaderText}"/>
                                </Border>

                                <DataGrid Grid.Row="4"
                                          x:Name="LinearGrid"
                                          Style="{StaticResource Style.BlotterDataGrid}"
                                          ItemsSource="{Binding LinearTradesView}"
                                          SelectedItem="{Binding SelectedLinearTrade, Mode=TwoWay}"
                                          ColumnHeaderStyle="{StaticResource Style.BlotterDataGridHeader}"
                                          CellStyle="{StaticResource Style.BlotterDataGridCell.Booked}"                                          
                                          RowStyle="{StaticResource Style.BlotterDataGridRow.Linear}"
                                          AutoGenerateColumns="False"
                                          CanUserSortColumns="False">

                                    <DataGrid.ContextMenu>
                                        <ContextMenu Style="{StaticResource Style.BlotterContextMenu}">
                                            <MenuItem Header="Book Trade" 
                                                      Command="{Binding BookTradeCommand}"
                                                      Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Duplicate Trade" 
                                                      Command="{Binding DuplicateTradeCommand}"
                                                      Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Book As Live Trade" 
                                                      Command="{Binding BookAsLiveTradeCommand}"
                                                      Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <Separator Style="{StaticResource Style.BlotterMenuSeparator}"/>
                                            <MenuItem Header="Cancel Calypso Trade" 
                                                      Command="{Binding CancelCalypsoTradeCommand}"
                                                      Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Delete Row" 
                                                      Command="{Binding DeleteRowCommand}"
                                                      Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <Separator Style="{StaticResource Style.BlotterMenuSeparator}"/>
                                            <MenuItem Header="Check If Trade Is Booked" 
                                                      Command="{Binding CheckIfBookedCommand}"
                                                      Style="{StaticResource Style.BlotterMenuItem}"/>
                                            <MenuItem Header="Open Error Log" 
                                                      Command="{Binding OpenErrorLogCommand}"
                                                      Style="{StaticResource Style.BlotterMenuItem}"/>
                                        </ContextMenu>
                                    </DataGrid.ContextMenu>

                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="TradeID" Binding="{Binding TradeId}" Width="120" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Counterpart" Binding="{Binding Counterparty}" Width="110" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Ccy Pair" Binding="{Binding CcyPair}" Width="80" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Buy/Sell" Binding="{Binding BuySell}" Width="70" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Notional" 
                                                            Binding="{Binding Notional, StringFormat=N0}"
                                                            CellStyle="{StaticResource Style.BlotterDataGridCell.Numeric}"
                                                            HeaderStyle="{StaticResource Style.BlotterDataGridHeader.Numeric}"
                                                            Width="90" 
                                                            IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Notional Ccy" Binding="{Binding NotionalCcy}" Width="100" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Hedge Rate" 
                                                            Binding="{Binding HedgeRate, StringFormat=F6}" 
                                                            CellStyle="{StaticResource Style.BlotterDataGridCell.Numeric}"
                                                            HeaderStyle="{StaticResource Style.BlotterDataGridHeader.Numeric}"
                                                            Width="100" 
                                                            IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Hedge Type" Binding="{Binding HedgeType}" Width="95" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="Settlement Date" Binding="{Binding SettlementDate, StringFormat=yyyy-MM-dd}" Width="120" IsReadOnly="True"/>

                                        <!-- EDITABLE: Book Calypso - Endast editerbar för Status="New" -->
                                        <DataGridTemplateColumn Header="Book Calypso" Width="110">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <ComboBox Style="{StaticResource Style.BlotterComboBox}"
                                                              ItemsSource="{Binding DataContext.BookCalypsoValues, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                              SelectedItem="{Binding CalypsoPortfolio, UpdateSourceTrigger=PropertyChanged}"
                                                              ItemContainerStyle="{StaticResource Style.BlotterComboBoxItem}"
                                                              IsEnabled="{Binding CanEdit}"
                                                              SelectionChanged="OnCalypsoComboBox_SelectionChanged"
                                                              DropDownOpened="OnCalypsoComboBox_DropDownOpened"
                                                              DropDownClosed="OnCalypsoComboBox_DropDownClosed"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>

                                        <!-- EDITABLE: Portfolio MX3 - Endast editerbar för Status="New" -->
                                        <DataGridTemplateColumn Header="Portfolio MX3" Width="110">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <ComboBox Style="{StaticResource Style.BlotterComboBox}"
                                                              ItemsSource="{Binding DataContext.PortfolioMx3Values, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                              SelectedItem="{Binding PortfolioMx3, UpdateSourceTrigger=PropertyChanged}"
                                                              ItemContainerStyle="{StaticResource Style.BlotterComboBoxItem}"
                                                              IsEnabled="{Binding CanEdit}"
                                                              SelectionChanged="OnPortfolioComboBox_SelectionChanged"
                                                              DropDownOpened="OnPortfolioComboBox_DropDownOpened"
                                                              DropDownClosed="OnPortfolioComboBox_DropDownClosed"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>

                                        <DataGridTextColumn Header="Trader" Binding="{Binding Trader}" Width="80" IsReadOnly="True"/>
                                        <DataGridTemplateColumn Header="Status" Width="150" CellTemplate="{StaticResource StatusPillTemplate}" CellStyle="{StaticResource Style.BlotterDataGridCell.Status}" IsReadOnly="True"/>
                                        <DataGridTextColumn  Header="STP" Width="50" Binding="{Binding StpFlag, Converter={StaticResource BoolToYesNoConverter}}" IsReadOnly="True"/>
                                    </DataGrid.Columns>

                                </DataGrid>
                            </Grid>

                            <!-- Column separator -->
                            <Border Grid.Column="1" Background="{StaticResource Brush.BorderSoft}"/>

                            
                            
                            
                            
                            <!-- RIGHT: Detail -->
                            <Border Grid.Column="2"
        Background="Transparent"
        Padding="12">

                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>

                                    <!-- Tabs -->
                                    <Border Style="{StaticResource Style.BlotterTabContainer}">

                                        <StackPanel Orientation="Horizontal">

                                            <RadioButton x:Name="TabSummary"
                             GroupName="DetailTabs"
                             IsChecked="True"
                             Style="{StaticResource DetailTabRadioStyle}"
                             Content="Summary"/>

                                            <RadioButton x:Name="TabEconomics"
                             GroupName="DetailTabs"
                             Style="{StaticResource DetailTabRadioStyle}"
                             Content="Economics"/>

                                            <RadioButton x:Name="TabRouting"
                             GroupName="DetailTabs"
                             Style="{StaticResource DetailTabRadioStyle}"
                             Content="Routing"/>

                                            <RadioButton x:Name="TabRegulatory"
                             GroupName="DetailTabs"
                             Style="{StaticResource DetailTabRadioStyle}"
                             Content="Regulatory"/>
                                            
                                        </StackPanel>
                                    </Border>

                                    <!-- Pages -->
                                    <Grid Grid.Row="1" Margin="0,12,0,0">

                                        <!-- SUMMARY PAGE -->
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ScrollViewer.Style>
                                                <Style TargetType="{x:Type ScrollViewer}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsChecked, ElementName=TabSummary}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ScrollViewer.Style>

                                            <StackPanel>

                                                <!-- TRADE SUMMARY card -->
                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="TRADE SUMMARY" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="120"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>

                                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="TradeID" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTrade.TradeId}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Counterpart" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedTrade.Counterparty}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Instrument" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedTrade.CcyPair}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Product" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding SelectedTrade.Product}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Side" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding SelectedTrade.BuySell}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="5" Grid.Column="0" Text="Notional" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="5" Grid.Column="1" Style="{StaticResource Style.BlotterRightValue}">
                                                                <TextBlock.Text>
                                                                    <MultiBinding StringFormat="{}{0:N0} {1}">
                                                                        <Binding Path="SelectedTrade.Notional"/>
                                                                        <Binding Path="SelectedTrade.NotionalCcy"/>
                                                                    </MultiBinding>
                                                                </TextBlock.Text>
                                                            </TextBlock>

                                                            <!-- Price (Strike för options, Rate för linjära) -->
                                                            <TextBlock Grid.Row="6" Grid.Column="0">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock" BasedOn="{StaticResource Style.BlotterRightKey}">
                                                                        <Setter Property="Text" Value="Rate"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding SelectedTrade.CallPut, Converter={StaticResource NullToBoolConverter}}" Value="True">
                                                                                <Setter Property="Text" Value="Strike"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                            <TextBlock Grid.Row="6" Grid.Column="1">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock" BasedOn="{StaticResource Style.BlotterRightValue}">
                                                                        <Setter Property="Text" Value="{Binding SelectedTrade.HedgeRate, StringFormat=F6, TargetNullValue=—}"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding SelectedTrade.CallPut, Converter={StaticResource NullToBoolConverter}}" Value="True">
                                                                                <Setter Property="Text" Value="{Binding SelectedTrade.Strike, StringFormat=F4, TargetNullValue=—}"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                            <TextBlock Grid.Row="7" Grid.Column="0" Text="TradeTime" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="7" Grid.Column="1" 
                                                                       Text="{Binding SelectedTrade.Time, Converter={StaticResource UtcToLocalTime}, StringFormat='yyyy-MM-dd HH:mm:ss'}" 
                                                                       Style="{StaticResource Style.BlotterRightValue}"/>
                                                        </Grid>

                                                    </StackPanel>
                                                </Border>

                                                <!-- WORKFLOW card -->
                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="SYSTEM LINKS" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <!-- System Links från DB -->
                                                        <ItemsControl ItemsSource="{Binding SelectedTradeSystemLinks}">
                                                            <ItemsControl.ItemsPanel>
                                                                <ItemsPanelTemplate>
                                                                    <WrapPanel/>
                                                                </ItemsPanelTemplate>
                                                            </ItemsControl.ItemsPanel>

                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Border Style="{StaticResource Style.BlotterChip}"
                            BorderBrush="{Binding Status, Converter={StaticResource SystemStatusToColor}}">
                                                                        <TextBlock Style="{StaticResource Style.BlotterChipText}">
                            <Run Text="{Binding SystemCode}"/>
                            <Run Text=": "/>
                            <Run Text="{Binding Status, TargetNullValue='New'}"/>
                                                                        </TextBlock>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>

                                                    </StackPanel>
                                                </Border>


                                            </StackPanel>
                                        </ScrollViewer>

                                        <!-- ECONOMICS PAGE -->
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ScrollViewer.Style>
                                                <Style TargetType="{x:Type ScrollViewer}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsChecked, ElementName=TabEconomics}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ScrollViewer.Style>



                                            <StackPanel>

                                                <!-- ============ PRODUCT STRUCTURE ============ -->
                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="PRODUCT STRUCTURE" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="120"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>

                                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Product" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTrade.Product, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="CcyPair" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedTrade.CcyPair, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Side" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedTrade.BuySell, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Notional" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="3" Grid.Column="1" Style="{StaticResource Style.BlotterRightValue}">
                                                                <TextBlock.Text>
                                                                    <MultiBinding StringFormat="{}{0:N0} {1}">
                                                                        <Binding Path="SelectedTrade.Notional"/>
                                                                        <Binding Path="SelectedTrade.NotionalCcy"/>
                                                                    </MultiBinding>
                                                                </TextBlock.Text>
                                                            </TextBlock>

                                                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Notional Ccy" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding SelectedTrade.NotionalCcy, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="6" Grid.Column="0" Text="Trade Date" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding SelectedTrade.Time, StringFormat=yyyy-MM-dd, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                        </Grid>
                                                    </StackPanel>
                                                </Border>

                                                <!-- ============ OPTION PRICING (endast för options) ============ -->
                                                <Border Style="{StaticResource Style.BlotterRightCard}" Visibility="{Binding SelectedTrade.CallPut, Converter={StaticResource NullToCollapsed}}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="OPTION PRICING" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="120"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>

                                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Call/Put" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTrade.CallPut, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Strike" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedTrade.Strike, StringFormat=F4, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Expiry Date" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedTrade.ExpiryDate, StringFormat=yyyy-MM-dd, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Value Date" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding SelectedTrade.SettlementDate, StringFormat=yyyy-MM-dd, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Premium" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="4" Grid.Column="1" Style="{StaticResource Style.BlotterRightValue}">
                                                                <TextBlock.Text>
                                                                    <MultiBinding StringFormat="{}{0:N2} {1}">
                                                                        <Binding Path="SelectedTrade.Premium"/>
                                                                        <Binding Path="SelectedTrade.PremiumCcy"/>
                                                                    </MultiBinding>
                                                                </TextBlock.Text>
                                                            </TextBlock>

                                                            <TextBlock Grid.Row="5" Grid.Column="0" Text="Premium %" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="5" Grid.Column="1" Text="—" Style="{StaticResource Style.BlotterRightValue}" Foreground="{StaticResource Brush.TextMuted2}"/>

                                                            <TextBlock Grid.Row="6" Grid.Column="0" Text="Premium Date" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding SelectedTrade.PremiumDate, StringFormat=yyyy-MM-dd, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                        </Grid>
                                                    </StackPanel>
                                                </Border>

                                                <!-- ============ LINEAR PRICING (endast för linear) ============ -->
                                                <Border Style="{StaticResource Style.BlotterRightCard}" Visibility="{Binding SelectedTrade.CallPut, Converter={StaticResource NullToVisible}}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="LINEAR PRICING" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="120"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>                                                                
                                                                <!-- NDF-specifika fält -->
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>

                                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Hedge Type" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTrade.HedgeType, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Hedge Rate" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedTrade.HedgeRate, StringFormat=F6, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Spot Rate" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedTrade.SpotRate, StringFormat=F6, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Swap Points" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding SelectedTrade.SwapPoints, StringFormat=F2, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- NDF-specifika fält - visas endast om IsNonDeliverable = true -->
                                                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Fixing Date" Style="{StaticResource Style.BlotterRightKey}">
                                                                <TextBlock.Visibility>
                                                                    <Binding Path="SelectedTrade.IsNonDeliverable" Converter="{StaticResource BoolToVisConverter}"/>
                                                                </TextBlock.Visibility>
                                                            </TextBlock>
                                                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding SelectedTrade.FixingDate, StringFormat=yyyy-MM-dd, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}">
                                                                <TextBlock.Visibility>
                                                                    <Binding Path="SelectedTrade.IsNonDeliverable" Converter="{StaticResource BoolToVisConverter}"/>
                                                                </TextBlock.Visibility>
                                                            </TextBlock>

                                                            <TextBlock Grid.Row="5" Grid.Column="0" Text="Settlement Date" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding SelectedTrade.SettlementDate, StringFormat=yyyy-MM-dd, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="6" Grid.Column="0" Text="Settlement Ccy" Style="{StaticResource Style.BlotterRightKey}">
                                                                <TextBlock.Visibility>
                                                                    <Binding Path="SelectedTrade.IsNonDeliverable" Converter="{StaticResource BoolToVisConverter}"/>
                                                                </TextBlock.Visibility>
                                                            </TextBlock>
                                                            <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding SelectedTrade.SettlementCurrency, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}">
                                                                <TextBlock.Visibility>
                                                                    <Binding Path="SelectedTrade.IsNonDeliverable" Converter="{StaticResource BoolToVisConverter}"/>
                                                                </TextBlock.Visibility>
                                                            </TextBlock>

                                                        </Grid>
                                                    </StackPanel>
                                                </Border>

                                                <!-- ============ PORTFOLIOS ============ -->
                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="PORTFOLIOS" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="120"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>

                                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="MX3 Portfolio" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTrade.PortfolioMx3, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Calypso Book" Style="{StaticResource Style.BlotterRightKey}">
                                                                <TextBlock.Visibility>
                                                                    <Binding Path="SelectedTrade.CalypsoPortfolio" Converter="{StaticResource NullToCollapsed}"/>
                                                                </TextBlock.Visibility>
                                                            </TextBlock>
                                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedTrade.CalypsoPortfolio}" Style="{StaticResource Style.BlotterRightValue}">
                                                                <TextBlock.Visibility>
                                                                    <Binding Path="SelectedTrade.CalypsoPortfolio" Converter="{StaticResource NullToCollapsed}"/>
                                                                </TextBlock.Visibility>
                                                            </TextBlock>

                                                        </Grid>
                                                    </StackPanel>
                                                </Border>

                                                <!-- SALES -->
                                                <Border>
                                                    <Border.Style>
                                                        <Style TargetType="Border" BasedOn="{StaticResource Style.BlotterRightCard}">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding SelectedTrade.ReportingEntityId}" Value="FX VOLATILITY">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="SALES" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="120"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>

                                                            <!-- Sales ID -->
                                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Sales ID" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTrade.InvDecisionId, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- Sales Name -->
                                                            <!-- TODO: Fyll från lookup table senare -->
                                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Sales Name" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="—" Style="{StaticResource Style.BlotterRightValue}" Foreground="{StaticResource Brush.TextMuted2}"/>

                                                            <!-- Reporting Entity -->
                                                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Reporting Entity" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedTrade.ReportingEntityId, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- Margin -->
                                                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Margin" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding SelectedTrade.Margin, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                        </Grid>
                                                    </StackPanel>
                                                </Border>

                                            </StackPanel>


                                        </ScrollViewer>

                                        <!-- ROUTING PAGE -->
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ScrollViewer.Style>
                                                <Style TargetType="{x:Type ScrollViewer}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsChecked, ElementName=TabRouting}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ScrollViewer.Style>

                                            <StackPanel>

                                                <!-- Error Message -->
                                                <Border Background="#1AEF4444"
            BorderBrush="#EF4444"
            BorderThickness="1"
            CornerRadius="{StaticResource Radius.Button}"
            Padding="10"
            Margin="0,0,0,10"
            Visibility="{Binding DetailsLastError, Converter={StaticResource NullToCollapsed}}">
                                                    <TextBlock Text="{Binding DetailsLastError}" 
                   Foreground="#EF4444" 
                   TextWrapping="Wrap"
                   FontSize="11"/>
                                                </Border>

                                                <!-- System Links Card -->
                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="ROUTING / SYSTEM LINKS" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <!-- Bind till SelectedTradeSystemLinks med utökade fält -->
                                                        <ItemsControl ItemsSource="{Binding SelectedTradeSystemLinks}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Border Style="{StaticResource Style.BlotterSystemCard}">
                                                                        <Grid>
                                                                            <Grid.ColumnDefinitions>
                                                                                <ColumnDefinition Width="*"/>
                                                                                <ColumnDefinition Width="Auto"/>
                                                                            </Grid.ColumnDefinitions>
                                                                            <Grid.RowDefinitions>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                            </Grid.RowDefinitions>

                                                                            <!-- System name -->
                                                                            <TextBlock Grid.Row="0" Grid.Column="0" 
                                           Text="{Binding SystemCode}" 
                                           Style="{StaticResource Style.BlotterSystemName}"/>

                                                                            <!-- Status badge -->
                                                                            <Border Grid.Row="0" Grid.Column="1" Grid.RowSpan="2"
                                        Style="{StaticResource Style.BlotterStatusBadge}"
                                        Margin="0,0,0,0">
                                                                                <StackPanel Orientation="Horizontal">
                                                                                    <Ellipse Width="6" Height="6" 
                                                 Margin="0,0,6,0"
                                                 VerticalAlignment="Center">
                                                                                        <Ellipse.Style>
                                                                                            <Style TargetType="Ellipse">
                                                                                                <Setter Property="Fill" Value="{StaticResource Brush.TextMuted}"/>
                                                                                                <Style.Triggers>
                                                                                                    <DataTrigger Binding="{Binding Status}" Value="New">
                                                                                                        <Setter Property="Fill" Value="#3B82F6"/>
                                                                                                    </DataTrigger>
                                                                                                    <DataTrigger Binding="{Binding Status}" Value="Booked">
                                                                                                        <Setter Property="Fill" Value="#2DD4BF"/>
                                                                                                    </DataTrigger>
                                                                                                    <DataTrigger Binding="{Binding Status}" Value="Pending">
                                                                                                        <Setter Property="Fill" Value="#FBBF24"/>
                                                                                                    </DataTrigger>
                                                                                                    <DataTrigger Binding="{Binding Status}" Value="Rejected">
                                                                                                        <Setter Property="Fill" Value="#FB7185"/>
                                                                                                    </DataTrigger>
                                                                                                    <DataTrigger Binding="{Binding Status}" Value="Partial">
                                                                                                        <Setter Property="Fill" Value="#FB923C"/>
                                                                                                    </DataTrigger>
                                                                                                </Style.Triggers>
                                                                                            </Style>
                                                                                        </Ellipse.Style>
                                                                                    </Ellipse>
                                                                                    <TextBlock Text="{Binding Status, TargetNullValue=Unknown}" 
                                                                                               Style="{StaticResource Style.BlotterStatusBadgeText}"/>

                                                                                </StackPanel>
                                                                            </Border>

                                                                            <!-- SystemLinkId -->
                                                                            <TextBlock Grid.Row="1" Grid.Column="0"
                                                                                       Style="{StaticResource Style.BlotterSystemCode}">
                                                                                <Run Text="SystemLinkId="/>
                                                                                <Run Text="{Binding SystemLinkId, Mode=OneWay}"/>
                                                                            </TextBlock>

                                                                            <!-- External TradeID -->
                                                                            <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,6,0,0">
                                                                                <Grid.ColumnDefinitions>
                                                                                    <ColumnDefinition Width="Auto"/>
                                                                                    <ColumnDefinition Width="*"/>
                                                                                </Grid.ColumnDefinitions>

                                                                                <TextBlock Grid.Column="0"
                                                                                           Text="External TradeID:" 
                                                                                           Foreground="{StaticResource Brush.TextMuted2}"
                                                                                           FontSize="11"
                                                                                           Margin="0,0,8,0"
                                                                                           VerticalAlignment="Center"/>

                                                                                <TextBlock Grid.Column="1"
                                                                                           Text="{Binding SystemTradeId, TargetNullValue=—}" 
                                                                                           Foreground="{StaticResource Brush.TextMuted}"
                                                                                           FontSize="11"
                                                                                           FontFamily="{StaticResource Font.Mono}"
                                                                                           VerticalAlignment="Center"
                                                                                           TextWrapping="Wrap"/>
                                                                            </Grid>

                                                                            <!-- Portfolio -->
                                                                            <Grid Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,4,0,0">
                                                                                <Grid.ColumnDefinitions>
                                                                                    <ColumnDefinition Width="Auto"/>
                                                                                    <ColumnDefinition Width="*"/>
                                                                                </Grid.ColumnDefinitions>

                                                                                <TextBlock Grid.Column="0"
                                                                                           Text="Portfolio:" 
                                                                                           Foreground="{StaticResource Brush.TextMuted2}"
                                                                                           FontSize="11"
                                                                                           Margin="0,0,8,0"
                                                                                           VerticalAlignment="Center"/>

                                                                                <TextBlock Grid.Column="1"
                                                                                           Text="{Binding PortfolioCode, TargetNullValue=—}" 
                                                                                           Foreground="{StaticResource Brush.Text}"
                                                                                           FontSize="11"
                                                                                           FontWeight="SemiBold"
                                                                                           VerticalAlignment="Center"/>
                                                                            </Grid>

                                                                            <!-- Last Status timestamp -->
                                                                            <Grid Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,4,0,0">
                                                                                <Grid.ColumnDefinitions>
                                                                                    <ColumnDefinition Width="Auto"/>
                                                                                    <ColumnDefinition Width="*"/>
                                                                                </Grid.ColumnDefinitions>

                                                                                <TextBlock Grid.Column="0"
                                                                                           Text="Last Status:" 
                                                                                           Foreground="{StaticResource Brush.TextMuted2}"
                                                                                           FontSize="11"
                                                                                           Margin="0,0,8,0"
                                                                                           VerticalAlignment="Center"/>

                                                                                <TextBlock Grid.Column="1"
                                                                                           Text="{Binding LastStatusUtc, Converter={StaticResource UtcToLocalTime}, StringFormat='yyyy-MM-dd HH:mm:ss', TargetNullValue=—}" 
                                                                                           Foreground="{StaticResource Brush.TextMuted}"
                                                                                           FontSize="11"
                                                                                           FontFamily="{StaticResource Font.Mono}"
                                                                                           VerticalAlignment="Center"/>

                                                                            </Grid>

                                                                            <!-- Error message (conditional) -->
                                                                            <Border Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="2" 
                                                                                    Margin="0,8,0,0"
                                                                                    Background="#1AEF4444"
                                                                                    BorderBrush="#EF4444"
                                                                                    BorderThickness="1"
                                                                                    CornerRadius="{StaticResource Radius.Button}"
                                                                                    Padding="8,6"
                                                                                    Visibility="{Binding LastError, Converter={StaticResource NullToCollapsed}}">
                                                                                <StackPanel Orientation="Horizontal">
                                                                                    <TextBlock Text="⚠ " 
                                                                                               Foreground="#EF4444"
                                                                                               FontSize="11"
                                                                                               Margin="0,0,4,0"
                                                                                               VerticalAlignment="Top"/>
                                                                                    <TextBlock Text="{Binding LastError}" 
                                                                                               Foreground="#EF4444"
                                                                                               FontSize="11"
                                                                                               TextWrapping="Wrap"
                                                                                               VerticalAlignment="Center"/>
                                                                                </StackPanel>
                                                                            </Border>

                                                                        </Grid>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>

                                                        <!-- Empty state -->
                                                        <TextBlock Text="No system links found"
                       Foreground="{StaticResource Brush.TextMuted2}"
                       FontStyle="Italic"
                       Margin="10"
                       HorizontalAlignment="Center">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding SelectedTradeSystemLinks.Count}" Value="0">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>

                                                    </StackPanel>
                                                </Border>

                                                <!-- D2.2D: WORKFLOW EVENTS card -->
                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="LATEST WORKFLOW EVENTS" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>

                                                        <!-- D2.2D: Bind till SelectedTradeWorkflowEvents -->
                                                        <ItemsControl ItemsSource="{Binding SelectedTradeWorkflowEvents}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Border Style="{StaticResource Style.BlotterEventRow}">
                                                                        <Grid>
                                                                            <Grid.RowDefinitions>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                            </Grid.RowDefinitions>

                                                                            <Grid.ColumnDefinitions>
                                                                                <ColumnDefinition Width="Auto"/>
                                                                                <!-- Timestamp -->
                                                                                <ColumnDefinition Width="12"/>
                                                                                <!-- Spacing -->
                                                                                <ColumnDefinition Width="Auto"/>
                                                                                <!-- Icon -->
                                                                                <ColumnDefinition Width="12"/>
                                                                                <!-- Spacing -->
                                                                                <ColumnDefinition Width="*"/>
                                                                                <!-- Content -->
                                                                            </Grid.ColumnDefinitions>

                                                                            <!-- Timestamp -->
                                                                            <TextBlock Grid.Row="0" Grid.Column="0"
                                                                                       Text="{Binding TimestampUtc, Converter={StaticResource UtcToLocalTime}, StringFormat='HH:mm:ss'}"
                                                                                       FontFamily="{StaticResource Font.Mono}"
                                                                                       FontSize="11"
                                                                                       Foreground="{StaticResource Brush.TextMuted2}"
                                                                                       VerticalAlignment="Center"
                                                                                       Margin="0"/>

                                                                            <!-- Event Type Icon -->
                                                                            <TextBlock Grid.Row="0" Grid.Column="2"
                                                                                       Text="{Binding EventType, Converter={StaticResource EventTypeToIcon}}"
                                                                                       FontSize="14"
                                                                                       Foreground="{Binding EventType, Converter={StaticResource EventTypeToColor}}"
                                                                                       VerticalAlignment="Center"
                                                                                       Margin="0"/>

                                                                            <!-- Event Type + System Code Badge -->
                                                                            <StackPanel Grid.Row="0" Grid.Column="4" 
                                                                                        Orientation="Horizontal" 
                                                                                        VerticalAlignment="Center">

                                                                                <TextBlock Text="{Binding EventType}" 
                                                                                           FontSize="13"
                                                                                           FontWeight="SemiBold"
                                                                                           Foreground="{StaticResource Brush.Text}"
                                                                                           VerticalAlignment="Center"
                                                                                           Margin="0"/>

                                                                                <!-- System Code badge -->
                                                                                <Border Background="#1A64748B"
                                                                                        BorderBrush="#64748B"
                                                                                        BorderThickness="1"
                                                                                        CornerRadius="4"
                                                                                        Padding="6,2"
                                                                                        Margin="8,0,0,0"
                                                                                        VerticalAlignment="Center">
                                                                                    
                                                                                    <TextBlock Text="{Binding SystemCode}" 
                                                                                               FontSize="10"
                                                                                               FontFamily="{StaticResource Font.Mono}"
                                                                                               Foreground="{StaticResource Brush.TextMuted}"
                                                                                               FontWeight="SemiBold"
                                                                                               VerticalAlignment="Center"/>
                                                                                </Border>
                                                                            </StackPanel>

                                                                            <!-- Details (bullet list) -->
                                                                            <ItemsControl Grid.Row="1" Grid.Column="4"
                                                                                          ItemsSource="{Binding Details, Converter={StaticResource DetailsToLines}}"
                                                                                          Margin="0,6,0,0">

                                                                                <ItemsControl.ItemTemplate>
                                                                                    <DataTemplate>
                                                                                        <TextBlock Text="{Binding}"
                                                                                                   FontSize="11"
                                                                                                   Foreground="{StaticResource Brush.TextMuted}"
                                                                                                   TextWrapping="Wrap"
                                                                                                   MaxWidth="400">
                                                                                            <TextBlock.ToolTip>
                                                                                                <ToolTip Content="{Binding}" MaxWidth="600">
                                                                                                    <ToolTip.ContentTemplate>
                                                                                                        <DataTemplate>
                                                                                                            <TextBlock Text="{Binding}" 
                                                                                                                       TextWrapping="Wrap"
                                                                                                                       MaxWidth="600"/>
                                                                                                        </DataTemplate>
                                                                                                    </ToolTip.ContentTemplate>
                                                                                                </ToolTip>
                                                                                            </TextBlock.ToolTip>
            </TextBlock>
                                                                                    </DataTemplate>
                                                                                </ItemsControl.ItemTemplate>
                                                                            </ItemsControl>

                                                                        </Grid>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>

                                                        <!-- Empty state -->
                                                        <TextBlock Text="No workflow events found"
                                                                   Foreground="{StaticResource Brush.TextMuted2}"
                                                                   FontStyle="Italic"
                                                                   Margin="10"
                                                                   HorizontalAlignment="Center">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding SelectedTradeWorkflowEvents.Count}" Value="0">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>

                                                    </StackPanel>
                                                </Border>

                                            </StackPanel>


                                        </ScrollViewer>

                                        <!-- REGULATORY PAGE -->
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <ScrollViewer.Style>
                                                <Style TargetType="{x:Type ScrollViewer}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsChecked, ElementName=TabRegulatory}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ScrollViewer.Style>

                                            <StackPanel>

                                                <Border Style="{StaticResource Style.BlotterRightCard}">
                                                    <StackPanel>
                                                        <Border Style="{StaticResource Style.BlotterSectionHeaderBorder}">
                                                            <TextBlock Text="REGULATORY FIELDS" Style="{StaticResource Style.BlotterRightSectionTitle}"/>
                                                        </Border>
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="120"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>

                                                            </Grid.RowDefinitions>

                                                            <!-- Trader ID - finns som Trader property -->
                                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Trader ID" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedTrade.Trader, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- Trader Name - från lookup (N/A tills vidare) -->
                                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Trader Name" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="N/A" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- Execution Time - finns som Time property -->
                                                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Execution Time" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SelectedTrade.Time, StringFormat='yyyy-MM-dd HH:mm:ss', TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- MIC - finns nu! -->
                                                            <TextBlock Grid.Row="3" Grid.Column="0" Text="MIC" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding SelectedTrade.Mic, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- TVTIC - finns nu! -->
                                                            <TextBlock Grid.Row="4" Grid.Column="0" Text="TVTIC" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding SelectedTrade.Tvtic, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- ISIN - finns nu! -->
                                                            <TextBlock Grid.Row="5" Grid.Column="0" Text="ISIN" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding SelectedTrade.Isin, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- Inv. Decision ID - finns nu! -->
                                                            <TextBlock Grid.Row="6" Grid.Column="0" Text="Inv. Decision ID" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding SelectedTrade.InvDecisionId, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- Inv. Decision Name - från lookup (N/A) -->
                                                            <TextBlock Grid.Row="7" Grid.Column="0" Text="Inv. Decision Name" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="7" Grid.Column="1" Text="N/A" Style="{StaticResource Style.BlotterRightValue}"/>

                                                            <!-- Reporting Entity. Decision ID - finns nu! -->
                                                            <TextBlock Grid.Row="8" Grid.Column="0" Text="Reporting Entity" Style="{StaticResource Style.BlotterRightKey}"/>
                                                            <TextBlock Grid.Row="8" Grid.Column="1" Text="{Binding SelectedTrade.ReportingEntityId, TargetNullValue=—}" Style="{StaticResource Style.BlotterRightValue}"/>



                                                        </Grid>
                                                    </StackPanel>
                                                </Border>



                                            </StackPanel>
                                        </ScrollViewer>

                                    </Grid>


                                </Grid>
                            </Border>



                        </Grid>

                    </Grid>
                </Border>

            </Grid>
            
              
            
        </Border>

        <!-- STATUSRAD - diskret längst ner -->
        <Border Background="{StaticResource Brush.Panel2}"
        BorderBrush="{StaticResource Brush.BorderSoft}"
        BorderThickness="0,1,0,0"
        Padding="8,4"
        Margin="{StaticResource Thickness.WindowPadding}"                
        VerticalAlignment="Bottom">

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Calypso countdown (vänster) -->
                <TextBlock Grid.Column="0"
                   FontSize="10"
                   Foreground="{StaticResource Brush.TextMuted2}">
            <Run Text="Next Calypso import: "/>
            <Run Text="{Binding CalypsoCountdown, Mode=OneWay}" 
                 FontFamily="{StaticResource Font.Mono}"/>
                </TextBlock>

                <!-- Normal state (höger) - dold när IsStale=True -->
                <TextBlock Grid.Column="2"
                   FontSize="10" 
                   Foreground="{StaticResource Brush.TextMuted2}"
                   HorizontalAlignment="Right"
                   x:Name="NormalStatus">
            <Run Text="Last refresh: "/>
            <Run Text="{Binding LastRefreshUtc, Mode=OneWay, StringFormat='HH:mm:ss', TargetNullValue='—'}"/>
            <Run Text=" ("/>
            <Run Text="{Binding LastRefreshDuration.TotalMilliseconds, Mode=OneWay, StringFormat='F0', TargetNullValue='—'}"/>
            <Run Text="ms)"/>
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsStale}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <!-- Error state (höger) - synlig när IsStale=True -->
                <TextBlock Grid.Column="2"
                   FontSize="10" 
                   Foreground="#EF4444"
                   HorizontalAlignment="Right"
                   x:Name="ErrorStatus">
            <Run Text="⚠ "/>
            <Run Text="Last refresh: "/>
            <Run Text="{Binding LastRefreshUtc, Mode=OneWay, StringFormat='HH:mm:ss', TargetNullValue='—'}"/>
            <Run Text=" — "/>
            <Run Text="{Binding LastError, Mode=OneWay}"/>
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsStale}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </Grid>

        </Border>

    </Grid>
</UserControl>
